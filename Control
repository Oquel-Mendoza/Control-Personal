import React, { useState, useEffect, useMemo } from 'react';
import { 
  Wallet, Plus, X, ChevronRight, Lock, LogOut, 
  LayoutGrid, PieChart as PieIcon, Settings, Trash2, 
  ShoppingBag, Coffee, Car, Home, Zap, Heart, Briefcase, 
  Smartphone, Plane, Gift, Music, Book, Smile, Star, 
  TrendingUp, TrendingDown, Target, Sun, Moon, User, 
  RefreshCcw, UserCircle2, Palette, Check, AlertTriangle,
  Clock, ShieldCheck, Ban
} from 'lucide-react';

// --- 1. CONFIGURACIÓN DE ICONOS Y COLORES ---

const ICON_MAP = {
  ShoppingBag, Coffee, Car, Home, Zap, Heart, Briefcase, 
  Smartphone, Plane, Gift, Music, Book, Smile, Star, 
  Target, User, Wallet
};

// COLORES SUAVIZADOS (Mates y Pasteles - No chillones)
const THEME_COLORS = {
  indigo: { name: 'Índigo', bg: 'bg-indigo-500', text: 'text-indigo-500', ring: 'ring-indigo-400' },
  blue:   { name: 'Azul',   bg: 'bg-blue-500',   text: 'text-blue-500',   ring: 'ring-blue-400' },
  emerald:{ name: 'Verde',  bg: 'bg-emerald-500',text: 'text-emerald-500',ring: 'ring-emerald-400' },
  violet: { name: 'Violeta',bg: 'bg-violet-500', text: 'text-violet-500', ring: 'ring-violet-400' },
  orange: { name: 'Naranja',bg: 'bg-orange-500', text: 'text-orange-500', ring: 'ring-orange-400' },
  rose:   { name: 'Rosa',   bg: 'bg-rose-500',   text: 'text-rose-500',   ring: 'ring-rose-400' },
  slate:  { name: 'Gris',   bg: 'bg-slate-500',  text: 'text-slate-500',  ring: 'ring-slate-400' },
};

const DEFAULT_CATS = [
  { id: 'c1', name: 'Comida', icon: 'Coffee', color: '#F59E0B' },
  { id: 'c2', name: 'Transporte', icon: 'Car', color: '#3B82F6' },
  { id: 'c3', name: 'Casa', icon: 'Home', color: '#10B981' },
  { id: 'c4', name: 'Ocio', icon: 'Smile', color: '#EC4899' },
];

const safeLoad = (key, fallback) => {
  try {
    const item = localStorage.getItem(key);
    return item ? JSON.parse(item) : fallback;
  } catch (e) { return fallback; }
};

const formatCordoba = (amount) => {
  return new Intl.NumberFormat('es-NI', { style: 'currency', currency: 'NIO', maximumFractionDigits: 0 }).format(amount);
};

const formatDate = (isoString) => {
  if (!isoString) return '';
  const date = new Date(isoString);
  return date.toLocaleDateString('es-NI', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' });
};

// --- 2. COMPONENTES UI ---

const Card = ({ children, className = "", onClick }) => (
  <div onClick={onClick} className={`bg-white dark:bg-zinc-900 p-5 rounded-2xl border border-slate-200 dark:border-zinc-800 transition-colors duration-200 ${className}`}>
    {children}
  </div>
);

const IconRenderer = ({ name, size = 20, className }) => {
  const Icon = ICON_MAP[name] || Star;
  return <Icon size={size} className={className} />;
};

// --- 3. APP PRINCIPAL ---

export default function App() {
  // --- ESTADOS ---
  const [config, setConfig] = useState(() => safeLoad('ew_ctrl_config', null));
  const [darkMode, setDarkMode] = useState(() => safeLoad('ew_dark_mode', true)); 

  const [isAuth, setIsAuth] = useState(false);
  const [pinInput, setPinInput] = useState('');
  const [errorMsg, setErrorMsg] = useState('');
  
  const [newUserName, setNewUserName] = useState('');
  const [newUserPin, setNewUserPin] = useState('');
  const [newUserPinConfirm, setNewUserPinConfirm] = useState('');

  const [transactions, setTransactions] = useState(() => safeLoad('ew_ctrl_trans', []));
  const [categories, setCategories] = useState(() => safeLoad('ew_ctrl_cats', DEFAULT_CATS));
  const [goals, setGoals] = useState(() => safeLoad('ew_ctrl_goals', []));

  const [walletMode, setWalletMode] = useState('personal'); 
  const [activeTab, setActiveTab] = useState('home');
  
  const [showTransModal, setShowTransModal] = useState(false);
  const [showCatModal, setShowCatModal] = useState(false);
  const [showCreateCat, setShowCreateCat] = useState(false);
  const [showGoalModal, setShowGoalModal] = useState(false);
  const [showNameEdit, setShowNameEdit] = useState(false);
  const [showResetConfirm, setShowResetConfirm] = useState(false);
  
  const [formError, setFormError] = useState('');

  const getNowInput = () => {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    return now.toISOString().slice(0,16);
  };
  const [transForm, setTransForm] = useState({ amount: '', desc: '', type: 'expense', categoryId: null, date: getNowInput() });
  const [catForm, setCatForm] = useState({ name: '', icon: 'Star', color: '#6366f1' });
  const [goalForm, setGoalForm] = useState({ name: '', target: '' });
  const [tempName, setTempName] = useState('');

  // --- EFECTOS ---
  useEffect(() => localStorage.setItem('ew_ctrl_trans', JSON.stringify(transactions)), [transactions]);
  useEffect(() => localStorage.setItem('ew_ctrl_cats', JSON.stringify(categories)), [categories]);
  useEffect(() => localStorage.setItem('ew_ctrl_goals', JSON.stringify(goals)), [goals]);
  useEffect(() => { if (config) localStorage.setItem('ew_ctrl_config', JSON.stringify(config)); }, [config]);
  useEffect(() => { localStorage.setItem('ew_dark_mode', JSON.stringify(darkMode)); }, [darkMode]);

  // --- GENERADOR DE APP (Icono y Nombre) ---
  useEffect(() => {
    // 1. Nombre de la App
    document.title = "Control Personal";

    // 2. Generar Icono Azul Elegante
    const svgIcon = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
        <rect width="512" height="512" rx="120" fill="#3B82F6"/>
        <path d="M128 176v160c0 17.7 14.3 32 32 32h192c17.7 0 32-14.3 32-32V176c0-17.7-14.3-32-32-32H160c-17.7 0-32 14.3-32 32zm32-10h192c5.5 0 10 4.5 10 10v160c0 5.5-4.5 10-10 10H160c-5.5 0-10-4.5-10-10V176c0-5.5 4.5-10 10-10z" fill="white"/>
        <path d="M320 256h32v32h-32z" fill="white"/>
        <path d="M140 140h232" stroke="white" stroke-width="30" stroke-linecap="round"/>
      </svg>
    `;
    const iconUrl = `data:image/svg+xml;base64,${btoa(svgIcon)}`;

    // 3. Inyectar Meta Tags
    const existingIcon = document.querySelector("link[rel*='icon']");
    if (!existingIcon) {
      const link = document.createElement('link');
      link.type = 'image/svg+xml';
      link.rel = 'icon';
      link.href = iconUrl;
      document.head.appendChild(link);
      
      const appleLink = document.createElement('link');
      appleLink.rel = 'apple-touch-icon';
      appleLink.href = iconUrl;
      document.head.appendChild(appleLink);
    }

    // Meta para iOS
    const metaTitle = document.createElement('meta');
    metaTitle.name = "apple-mobile-web-app-title";
    metaTitle.content = "Control Personal";
    document.head.appendChild(metaTitle);

    // Meta para pantalla completa
    const metaWeb = document.createElement('meta');
    metaWeb.name = "apple-mobile-web-app-capable";
    metaWeb.content = "yes";
    document.head.appendChild(metaWeb);

  }, []);

  // --- LOGICA PERFILES ---
  const safeConfig = config || { personal: {}, partner: {} };
  const currentProfile = safeConfig[walletMode] || { name: 'Usuario', theme: 'blue', gender: 'male' };
  const theme = THEME_COLORS[currentProfile.theme] || THEME_COLORS.blue;

  const updateProfile = (updates) => {
    if (!config) return;
    setConfig(prev => ({ ...prev, [walletMode]: { ...prev[walletMode], ...updates } }));
  };

  const handleResetProfileData = () => {
    const otherTrans = transactions.filter(t => t.walletMode !== walletMode);
    const otherGoals = goals.filter(g => g.walletMode !== walletMode);
    setTransactions(otherTrans);
    setGoals(otherGoals);
    updateProfile({ theme: walletMode === 'personal' ? 'blue' : 'rose', gender: walletMode === 'personal' ? 'male' : 'female' });
    setShowResetConfirm(false);
  };

  const handleFinishSetup = () => {
    if (!newUserName.trim() || newUserPin.length < 4) return;
    if (newUserPin !== newUserPinConfirm) { setErrorMsg('PINs no coinciden'); return; }
    const newConfig = {
      pin: newUserPin,
      personal: { name: newUserName, theme: 'blue', gender: 'male' },
      partner: { name: 'Pareja', theme: 'rose', gender: 'female' }
    };
    setConfig(newConfig);
    localStorage.setItem('ew_ctrl_config', JSON.stringify(newConfig));
    setIsAuth(true); 
  };

  const handleLogin = (e) => {
    e.preventDefault();
    if (pinInput === config.pin) { setIsAuth(true); setErrorMsg(''); } 
    else setErrorMsg('PIN Incorrecto');
  };

  // --- CALCULOS ---
  const safeTransactions = Array.isArray(transactions) ? transactions : [];
  const currentData = safeTransactions.filter(t => t.walletMode === walletMode);
  const currentGoals = Array.isArray(goals) ? goals.filter(g => g.walletMode === walletMode) : [];

  const income = currentData.filter(t => t.type === 'income').reduce((acc, t) => acc + (Number(t.amount) || 0), 0);
  const expense = currentData.filter(t => t.type === 'expense').reduce((acc, t) => acc + (Number(t.amount) || 0), 0);
  const balance = income - expense;
  const sortedData = [...currentData].sort((a, b) => new Date(b.date) - new Date(a.date));

  const chartData = useMemo(() => {
    const data = currentData.filter(t => t.type === 'expense')
      .reduce((acc, t) => {
        const cat = categories.find(c => c.id === t.categoryId) || { name: 'Otros', color: '#94a3b8' };
        const found = acc.find(i => i.name === cat.name);
        if (found) found.value += Number(t.amount);
        else acc.push({ name: cat.name, value: Number(t.amount), color: cat.color });
        return acc;
      }, []).sort((a, b) => b.value - a.value);
    
    const total = data.reduce((acc, curr) => acc + curr.value, 0);
    let currentDeg = 0;
    const gradientParts = data.map(d => {
      const deg = total === 0 ? 0 : (d.value / total) * 360;
      const str = `${d.color} ${currentDeg}deg ${currentDeg + deg}deg`;
      currentDeg += deg;
      return str;
    });
    return { data, gradient: gradientParts.join(', ') || '#3f3f46 0deg 360deg', total };
  }, [currentData, categories]);

  // --- HANDLERS ---
  const handleAddTrans = () => {
    setFormError('');
    const amount = Number(transForm.amount);
    if (!amount || amount <= 0) { setFormError('Monto inválido'); return; }
    if (!transForm.categoryId) { setFormError('Elige categoría'); return; }
    if (transForm.type === 'expense') {
      if (amount > balance) { setFormError('Fondos insuficientes'); return; }
    }
    const newTx = {
      id: Date.now(), walletMode, 
      amount: amount, description: transForm.desc || '', 
      type: transForm.type, categoryId: transForm.categoryId, 
      date: transForm.date || new Date().toISOString()
    };
    setTransactions([newTx, ...transactions]);
    setShowTransModal(false);
    setTransForm({ amount: '', desc: '', type: 'expense', categoryId: null, date: getNowInput() });
  };

  const handleAddGoal = () => {
    setFormError('');
    const target = Number(goalForm.target);
    if(!goalForm.name || !target || target <= 0) { return; }
    setGoals([...goals, { 
      id: Date.now(), walletMode, name: goalForm.name, target: target, current: 0, 
      color: categories[Math.floor(Math.random()*categories.length)].color 
    }]);
    setShowGoalModal(false);
    setGoalForm({ name: '', target: '' });
  };

  const handleUpdateName = () => {
    if(tempName.trim()) { updateProfile({ name: tempName }); setShowNameEdit(false); }
  };

  // --- RENDER ---
  return (
    <div className={darkMode ? "dark" : ""}>
      <div className="min-h-screen bg-slate-50 dark:bg-black text-slate-800 dark:text-slate-200 transition-colors duration-300 font-sans overflow-x-hidden">

        {/* VISTA SETUP */}
        {!config && (
          <div className="min-h-screen flex items-center justify-center p-6">
            <button onClick={() => setDarkMode(!darkMode)} className="absolute top-6 right-6 p-3 rounded-full bg-white dark:bg-zinc-900 shadow-sm border border-slate-100 dark:border-zinc-800">{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
            <div className="w-full max-w-sm bg-white dark:bg-zinc-900 rounded-3xl p-8 shadow-lg border border-slate-100 dark:border-zinc-800">
              <div className="flex justify-center mb-6"><div className="bg-blue-500 p-4 rounded-2xl shadow-md"><ShieldCheck className="text-white" size={40} /></div></div>
              <h2 className="text-2xl font-bold text-center mb-2 text-slate-900 dark:text-white">Crear Cuenta</h2>
              <p className="text-slate-400 text-center text-sm mb-8">Configura tu acceso personal.</p>
              <div className="space-y-4">
                <div><label className="text-xs font-bold uppercase text-slate-400 ml-1">Tu Nombre</label><input className="w-full mt-1 p-4 bg-slate-50 dark:bg-zinc-800 rounded-xl font-bold outline-none focus:ring-2 focus:ring-blue-400 text-slate-900 dark:text-white" placeholder="Ej. Juan" value={newUserName} onChange={e => setNewUserName(e.target.value)} /></div>
                <div><label className="text-xs font-bold uppercase text-slate-400 ml-1">PIN (4 dígitos)</label><input type="password" maxLength={4} inputMode="numeric" className="w-full mt-1 p-4 bg-slate-50 dark:bg-zinc-800 rounded-xl font-bold outline-none focus:ring-2 focus:ring-blue-400 text-slate-900 dark:text-white tracking-widest text-center" placeholder="••••" value={newUserPin} onChange={e => setNewUserPin(e.target.value)} /></div>
                <div><label className="text-xs font-bold uppercase text-slate-400 ml-1">Confirma el PIN</label><input type="password" maxLength={4} inputMode="numeric" className="w-full mt-1 p-4 bg-slate-50 dark:bg-zinc-800 rounded-xl font-bold outline-none focus:ring-2 focus:ring-blue-400 text-slate-900 dark:text-white tracking-widest text-center" placeholder="••••" value={newUserPinConfirm} onChange={e => { setNewUserPinConfirm(e.target.value); setErrorMsg(''); }} /></div>
                {errorMsg && <p className="text-rose-500 text-xs text-center font-bold">{errorMsg}</p>}
                <button onClick={handleFinishSetup} disabled={!newUserName || newUserPin.length < 4 || newUserPin !== newUserPinConfirm} className="w-full bg-blue-500 disabled:bg-slate-300 dark:disabled:bg-zinc-800 text-white font-bold py-4 rounded-xl shadow-md mt-4 transition-all">Empezar</button>
              </div>
            </div>
          </div>
        )}

        {/* VISTA LOGIN */}
        {config && !isAuth && (
          <div className="min-h-screen flex items-center justify-center p-6">
            <button onClick={() => setDarkMode(!darkMode)} className="absolute top-6 right-6 p-3 rounded-full bg-white/10 backdrop-blur-sm text-white hover:bg-white/20 transition-colors">{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
            <div className="absolute inset-0 bg-slate-900 z-[-1]" />
            <div className="w-full max-w-sm bg-white dark:bg-zinc-950 rounded-3xl p-8 shadow-xl border border-transparent dark:border-zinc-800">
              <div className="flex justify-center mb-6"><div className="bg-zinc-800 p-4 rounded-2xl shadow-md"><Lock className="text-white" size={32} /></div></div>
              <h2 className="text-2xl font-bold text-center text-slate-800 dark:text-white mb-1">Hola, {safeConfig.personal?.name || 'Usuario'}</h2>
              <p className="text-slate-400 text-center text-sm mb-8">Control Personal</p>
              <form onSubmit={handleLogin} className="space-y-6">
                <input type="password" maxLength={4} inputMode="numeric" className="w-full bg-slate-100 dark:bg-zinc-900 border-none rounded-2xl py-4 text-center text-3xl font-bold tracking-[1em] text-slate-800 dark:text-white focus:ring-2 focus:ring-slate-300 dark:focus:ring-zinc-700 outline-none" placeholder="••••" value={pinInput} onChange={(e) => setPinInput(e.target.value)} />
                {errorMsg && <p className="text-rose-500 text-xs text-center font-bold">{errorMsg}</p>}
                <button className="w-full bg-slate-800 dark:bg-blue-600 text-white font-bold py-4 rounded-xl shadow-md hover:scale-[1.02] transition-all">Entrar</button>
              </form>
              <div className="mt-8 pt-6 border-t border-slate-100 dark:border-zinc-900 flex justify-center">
                 <button onClick={() => { if(confirm("¿Borrar todos los datos y empezar de cero?")) { localStorage.clear(); window.location.reload(); }}} className="text-xs text-rose-400 flex items-center gap-1 hover:underline"><RefreshCcw size={12}/> Resetear</button>
              </div>
            </div>
          </div>
        )}

        {/* APP UI */}
        {config && isAuth && (
          <>
            <header className={`${theme.bg} pt-8 pb-20 px-6 rounded-b-[2.5rem] shadow-lg relative overflow-hidden transition-colors duration-500`}>
              <div className="absolute inset-0 opacity-10 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-white/20 to-transparent"></div>
              
              <div className="relative z-10 flex justify-center mb-6">
                <div className="bg-black/20 p-1 rounded-full flex backdrop-blur-sm max-w-full overflow-hidden">
                  <button onClick={() => setWalletMode('personal')} className={`px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 transition-all truncate max-w-[150px] ${walletMode === 'personal' ? 'bg-white text-slate-800 shadow-sm' : 'text-white/70 hover:text-white'}`}><User size={14} className="shrink-0" /> <span className="truncate">{safeConfig.personal?.name || 'Mío'}</span></button>
                  <button onClick={() => setWalletMode('partner')} className={`px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 transition-all truncate max-w-[150px] ${walletMode === 'partner' ? 'bg-white text-slate-800 shadow-sm' : 'text-white/70 hover:text-white'}`}><Heart size={14} className="shrink-0" /> <span className="truncate">{safeConfig.partner?.name || 'Pareja'}</span></button>
                </div>
              </div>
              <div className="relative z-10 text-center text-white">
                <span className="text-white/80 text-xs font-medium uppercase tracking-wider">Disponible</span>
                <h1 className="text-5xl font-bold tracking-tight mt-1 mb-6">{formatCordoba(balance)}</h1>
                <div className="flex justify-center gap-3">
                  <div className="bg-white/10 backdrop-blur-sm px-4 py-2 rounded-xl flex items-center gap-2 border border-white/5"><div className="bg-emerald-400/20 p-1 rounded-full"><TrendingUp size={14} className="text-emerald-200"/></div><span className="font-bold text-sm">+{formatCordoba(income)}</span></div>
                  <div className="bg-white/10 backdrop-blur-sm px-4 py-2 rounded-xl flex items-center gap-2 border border-white/5"><div className="bg-rose-400/20 p-1 rounded-full"><TrendingDown size={14} className="text-rose-200"/></div><span className="font-bold text-sm">-{formatCordoba(expense)}</span></div>
                </div>
              </div>
            </header>

            <main className="px-5 -mt-10 relative z-20 space-y-6 pb-24">
              {activeTab === 'home' && (
                <>
                  <div className="grid grid-cols-2 gap-4">
                    <button onClick={() => { setTransForm({...transForm, type: 'income'}); setShowTransModal(true); setFormError(''); }} className="bg-white dark:bg-zinc-900 p-4 rounded-2xl shadow-sm flex items-center gap-3 active:scale-95 transition-transform border border-slate-100 dark:border-zinc-800">
                      <div className="bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 p-3 rounded-full"><TrendingUp size={20}/></div>
                      <div className="text-left"><span className="block font-bold text-sm text-slate-700 dark:text-white">Ingreso</span><span className="text-[10px] text-slate-400">Recibir</span></div>
                    </button>
                    <button onClick={() => { setTransForm({...transForm, type: 'expense'}); setShowTransModal(true); setFormError(''); }} className="bg-white d
