<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control Personal</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#2563eb">

    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0iIzI1NjNlYiIvPjxwYXRoIGQ9Ik0xMjggMTc2djE2MGMwIDE3LjcgMTQuMyAzMiAzMiAzMmgxOTJjMTcuNyAwIDMyLTE0LjMgMzItMzJ2LTE2MGMwLTE3LjctMTQuMy0zMi0zMi0zMkgxNjBjLTE3LjcgMC0zMiAxNC4zLTMyIDMyem0zMi0xMGgxOTJjNS41IDAgMTAgNC41IDEwIDEwdjE2MGMwIDUuNS00LjUiMTAtMTAgMTBIMTYwYy01LjUgMC0xMC00LjUtMTAtMTBWMTc2YzAtNS41IDQuNS0xMCAxMC0xMHoiIGZpbGw9IndoaXRlIi8+PHBhdGggZD0iTTMyMCAyNTZoMzJ2MzJoLTMyeiIgZmlsbD0id2hpdGUiLz48cGF0aCBkPSJNMTQwIDE0MGgyMzIiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMzAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvc3ZnPg==">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0iIzI1NjNlYiIvPjxwYXRoIGQ9Ik0xMjggMTc2djE2MGMwIDE3LjcgMTQuMyAzMiAzMiAzMmgxOTJjMTcuNyAwIDMyLTE0LjMgMzItMzJ2LTE2MGMwLTE3LjctMTQuMy0zMi0zMi0zMkgxNjBjLTE3LjcgMC0zMiAxNC4zLTMyIDMyem0zMi0xMGgxOTJjNS41IDAgMTAgNC41IDEwIDEwdjE2MGMwIDUuNS00LjUiMTAtMTAgMTBIMTYwYy01LjUgMC0xMC00LjUtMTAtMTBWMTc2YzAtNS41IDQuNS0xMCAxMC0xMHoiIGZpbGw9IndoaXRlIi8+PHBhdGggZD0iTTMyMCAyNTZoMzJ2MzJoLTMyeiIgZmlsbD0id2hpdGUiLz48cGF0aCBkPSJNMTQwIDE0MGgyMzIiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMzAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvc3ZnPg==">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { slate: { 850: '#1e293b', 900: '#0f172a' } }, fontFamily: { sans: ['system-ui', '-apple-system', 'sans-serif'] } } }
        }
    </script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-tap-highlight-color: transparent; user-select: none; overscroll-behavior-y: none; }
        input, textarea { user-select: text; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .toast-in { animation: toastIn 0.3s ease-out forwards; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .toast-out { animation: toastOut 0.3s ease-in forwards; }
        @keyframes toastOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(20px); } }
        #loading-screen { position: fixed; inset: 0; background: #0f172a; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 9999; transition: opacity 0.5s; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 h-screen overflow-hidden select-none transition-colors duration-300">
    
    <div id="loading-screen">
        <div class="text-4xl mb-4">üìÇ</div>
        <h2 class="text-xl font-bold">Control Personal</h2>
        <p class="text-sm text-slate-400 mt-2">Cargando Sistema...</p>
    </div>

    <div id="root" class="h-full overflow-y-auto scrollbar-hide"></div>

    <script>
        window.onerror = function(msg, url, line) {
            const loader = document.getElementById('loading-screen');
            if(loader) {
                loader.innerHTML = `<div style="padding:20px;text-align:center;color:#ff6b6b;"><h3>‚ö†Ô∏è Error</h3><p>${msg}</p></div>`;
            }
        };
        // REGISTRO DEL SERVICE WORKER (Dejamos la ruta simple por ahora)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW fail', err)); });
        }
        
        // Quitar la pantalla de carga pase lo que pase
        setTimeout(() => {
            const loader = document.getElementById('loading-screen');
            if(loader) { loader.style.opacity = '0'; setTimeout(() => loader.remove(), 500); }
        }, 1500);
    </script>

    <script type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Wallet, Plus, X, ChevronRight, Lock, LogOut, 
            LayoutGrid, PieChart as PieIcon, Settings, Trash2, 
            ShoppingBag, Coffee, Car, Home, Zap, Heart, Briefcase, 
            Smartphone, Plane, Gift, Music, Book, Smile, Star, 
            TrendingUp, TrendingDown, Target, Sun, Moon, User, 
            RefreshCcw, UserCircle2, Palette, Check, AlertTriangle,
            Clock, ShieldCheck, Ban, FileText, Download, Calendar, FileSpreadsheet,
            Upload, Edit3, Save, MoreVertical, AlertCircle
        } from 'https://esm.sh/lucide-react@0.263.1';

        const ICON_MAP = { ShoppingBag, Coffee, Car, Home, Zap, Heart, Briefcase, Smartphone, Plane, Gift, Music, Book, Smile, Star, Target, User, Wallet, FileText };
        
        const THEME_COLORS = {
            blue:   { name: 'Azul',   bg: 'bg-blue-600',   text: 'text-blue-600',   ring: 'ring-blue-400' },
            indigo: { name: '√çndigo', bg: 'bg-indigo-500', text: 'text-indigo-500', ring: 'ring-indigo-400' },
            emerald:{ name: 'Verde',  bg: 'bg-emerald-600',text: 'text-emerald-600',ring: 'ring-emerald-400' },
            orange: { name: 'Naranja',bg: 'bg-orange-500', text: 'text-orange-500', ring: 'ring-orange-400' },
            rose:   { name: 'Rosa',   bg: 'bg-rose-500',   text: 'text-rose-500',   ring: 'ring-rose-400' },
            slate:  { name: 'Negro',  bg: 'bg-slate-700',  text: 'text-slate-700',  ring: 'ring-slate-400' },
        };

        const DEFAULT_CATS = [
            { id: 'c1', name: 'Comida', icon: 'Coffee', color: '#F59E0B' },
            { id: 'c2', name: 'Transporte', icon: 'Car', color: '#3B82F6' },
            { id: 'c3', name: 'Casa', icon: 'Home', color: '#10B981' },
            { id: 'c4', name: 'Ocio', icon: 'Smile', color: '#EC4899' },
        ];

        // --- HOOKS DE UTILIDAD ---
        const useLocalStorage = (key, fallback) => {
            const [value, setValue] = useState(() => {
                try { const item = localStorage.getItem(key); return item ? JSON.parse(item) : fallback; } catch (e) { return fallback; }
            });
            useEffect(() => {
                try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { console.error(`Error guardando ${key} en localStorage`, e); }
            }, [key, value]);
            return [value, setValue];
        };
        
        // --- FORMATTERS ---
        const formatCordoba = (amount) => new Intl.NumberFormat('es-NI', { style: 'currency', currency: 'NIO', maximumFractionDigits: 0 }).format(amount);
        const formatDate = (isoString) => { 
            if (!isoString) return ''; 
            const date = new Date(isoString); 
            return date.toLocaleDateString('es-NI', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' }); 
        };
        const getNowInput = () => { const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); return now.toISOString().slice(0, 16); };

        // --- COMPONENTES UI ---
        const Card = ({ children, className = "", onClick }) => React.createElement('div', { onClick, className: `bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm ${className}` }, children);
        const IconRenderer = ({ name, size = 20, className }) => { const Icon = ICON_MAP[name] || Star; return React.createElement(Icon, { size, className }); };

        function App() {
            // --- STATE ---
            const [config, setConfig] = useLocalStorage('ew_ctrl_config', null);
            const [darkMode, setDarkMode] = useLocalStorage('ew_dark_mode', true);
            const [isAuth, setIsAuth] = useState(false);
            const [pinInput, setPinInput] = useState('');
            const [errorMsg, setErrorMsg] = useState('');
            const [newUserName, setNewUserName] = useState('');
            const [newUserPin, setNewUserPin] = useState('');
            const [newUserPinConfirm, setNewUserPinConfirm] = useState('');
            const [transactions, setTransactions] = useLocalStorage('ew_ctrl_trans', []);
            const [categories, setCategories] = useLocalStorage('ew_ctrl_cats', DEFAULT_CATS);
            const [goals, setGoals] = useLocalStorage('ew_ctrl_goals', []);
            const [walletMode, setWalletMode] = useState('personal');
            const [activeTab, setActiveTab] = useState('home');
            
            // --- MODAL STATE ---
            const [showTransModal, setShowTransModal] = useState(false);
            const [showCatModal, setShowCatModal] = useState(false);
            const [showCreateCat, setShowCreateCat] = useState(false);
            const [showGoalModal, setShowGoalModal] = useState(false);
            const [showNameEdit, setShowNameEdit] = useState(false);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [showReportModal, setShowReportModal] = useState(false);
            const [showManageCat, setShowManageCat] = useState(false);
            const [editingCat, setEditingCat] = useState(null);
            
            // --- FORM STATE ---
            const [formError, setFormError] = useState('');
            const [tempName, setTempName] = useState('');
            const [reportFilter, setReportFilter] = useState('month');
            const [customStart, setCustomStart] = useState('');
            const [customEnd, setCustomEnd] = useState('');
            const [transForm, setTransForm] = useState({ amount: '', desc: '', type: 'expense', categoryId: null, date: getNowInput() });
            const [catForm, setCatForm] = useState({ name: '', icon: 'Star', color: '#6366f1' });
            const [goalForm, setGoalForm] = useState({ name: '', target: '' });
            
            // --- NUEVO STATE PARA MEJORAS ---
            const [editingTx, setEditingTx] = useState(null); 
            const [toast, setToast] = useState(null); 
            const fileInputRef = useRef(null); 

            // --- EFECTOS ---
            useEffect(() => {
                if (config) {
                    let fixed = false;
                    const newConfig = { ...config };
                    if (!newConfig.personal) { newConfig.personal = { name: 'M√≠o', theme: 'blue', gender: 'male' }; fixed = true; }
                    if (!newConfig.partner) { newConfig.partner = { name: 'Pareja', theme: 'rose', gender: 'female' }; fixed = true; }
                    if (fixed) setConfig(newConfig);
                }
            }, [config]);

            useEffect(() => {
                localStorage.setItem('ew_dark_mode', JSON.stringify(darkMode));
                document.documentElement.classList.toggle('dark', darkMode);
            }, [darkMode]);
            
            useEffect(() => {
                document.documentElement.classList.toggle('dark', darkMode);
            }, []);

            // --- C√ÅLCULOS DERIVADOS ---
            const safeConfig = config || { personal: { name: 'Usuario' }, partner: { name: 'Pareja' } };
            const currentProfile = safeConfig[walletMode] || (walletMode === 'personal' ? { name: 'M√≠o', theme: 'blue' } : { name: 'Pareja', theme: 'rose' });
            const theme = THEME_COLORS[currentProfile.theme] || THEME_COLORS.blue;
            
            const currentData = transactions.filter(t => t.walletMode === walletMode);
            const currentGoals = goals.filter(g => g.walletMode === walletMode);
            const income = currentData.filter(t => t.type === 'income').reduce((acc, t) => acc + (Number(t.amount) || 0), 0);
            const expense = currentData.filter(t => t.type === 'expense').reduce((acc, t) => acc + (Number(t.amount) || 0), 0);
            const balance = income - expense;
            const sortedData = [...currentData].sort((a, b) => new Date(b.date) - new Date(a.date));

            // --- HANDLERS (L√≥gica de la App) ---

            const showToast = (message) => { 
                setToast({ message }); 
                setTimeout(() => setToast(null), 2000);
            };

            const getFilteredDataForReport = () => {
                const now = new Date();
                let filtered = currentData;
                if (reportFilter === 'month') { filtered = currentData.filter(t => { const d = new Date(t.date); return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear(); }); }
                else if (reportFilter === 'prev_month') { const prevMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1); filtered = currentData.filter(t => { const d = new Date(t.date); return d.getMonth() === prevMonth.getMonth() && d.getFullYear() === prevMonth.getFullYear(); }); }
                else if (reportFilter === 'custom' && customStart && customEnd) { filtered = currentData.filter(t => { const d = new Date(t.date); return d >= new Date(customStart) && d <= new Date(customEnd); }); }
                else if (reportFilter === 'all') { filtered = currentData; }
                return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            };

            const handleFinishSetup = () => {
                if (!newUserName.trim() || newUserPin.length < 4) return;
                if (newUserPin !== newUserPinConfirm) { setErrorMsg('PINs no coinciden'); return; }
                const newConfig = { pin: newUserPin, personal: { name: newUserName, theme: 'blue', gender: 'male' }, partner: { name: 'Pareja', theme: 'rose', gender: 'female' } };
                setConfig(newConfig);
                setIsAuth(true);
            };

            const handleLogin = (e) => { e.preventDefault(); if (pinInput === config.pin) { setIsAuth(true); setErrorMsg(''); } else setErrorMsg('PIN Incorrecto'); };

            const resetTransForm = () => {
                setTransForm({ amount: '', desc: '', type: 'expense', categoryId: null, date: getNowInput() });
                setEditingTx(null);
                setFormError('');
            };

            const handleOpenNewTx = (type = 'expense') => {
                resetTransForm();
                setTransForm(prev => ({ ...prev, type }));
                setShowTransModal(true);
            };

            const handleStartEdit = (tx) => {
                setFormError('');
                setEditingTx(tx);
                setTransForm({
                    amount: tx.amount,
                    desc: tx.description,
                    type: tx.type,
                    categoryId: tx.categoryId,
                    date: tx.date.slice(0, 16) 
                });
                setShowTransModal(true);
            };

            const handleDeleteTrans = () => {
                if (!editingTx) return;
                setTransactions(transactions.filter(t => t.id !== editingTx.id));
                setShowTransModal(false);
                resetTransForm();
                showToast('Movimiento eliminado');
            };

            const handleSaveTrans = () => {
                setFormError('');
                const amount = Number(transForm.amount);
                if (!amount || amount <= 0) { setFormError('Monto inv√°lido'); return; }
                if (!transForm.categoryId) { setFormError('Elige categor√≠a'); return; }
                
                if (editingTx) {
                    const originalAmount = Number(editingTx.amount) || 0;
                    const originalType = editingTx.type;
                    let incomeChange = 0;
                    let expenseChange = 0;
                    if (originalType === 'income') incomeChange -= originalAmount;
                    else expenseChange -= originalAmount;
                    if (transForm.type === 'income') incomeChange += amount;
                    else expenseChange += amount;
                    if ((expense + expenseChange) > (income + incomeChange)) {
                        setFormError('Fondos insuficientes'); return;
                    }
                    const updatedTx = { ...editingTx, 
                        amount: Number(amount), 
                        description: transForm.desc || '', 
                        type: transForm.type, 
                        categoryId: transForm.categoryId, 
                        date: transForm.date || new Date().toISOString() 
                    };
                    setTransactions(transactions.map(t => t.id === editingTx.id ? updatedTx : t));
                    showToast('Movimiento actualizado');
                } else {
                    if (transForm.type === 'expense' && amount > balance) { setFormError('Fondos insuficientes'); return; }
                    const newTx = { 
                        id: Date.now().toString(), 
                        walletMode, 
                        amount: Number(amount), 
                        description: transForm.desc || '', 
                        type: transForm.type, 
                        categoryId: transForm.categoryId, 
                        date: transForm.date || new Date().toISOString() 
                    };
                    setTransactions([newTx, ...transactions]);
                    showToast(transForm.type === 'expense' ? 'Gasto guardado' : 'Ingreso guardado');
                }
                setShowTransModal(false);
                resetTransForm();
            };

            const handleResetProfileData = () => {
                const otherTrans = transactions.filter(t => t.walletMode !== walletMode);
                const otherGoals = goals.filter(g => g.walletMode !== walletMode);
                setTransactions(otherTrans);
                setGoals(otherGoals);
                updateProfile({ theme: walletMode === 'personal' ? 'blue' : 'rose', gender: walletMode === 'personal' ? 'male' : 'female' });
                setShowResetConfirm(false);
            };

            const updateProfile = (updates) => { if (!config) return; setConfig(prev => ({ ...prev, [walletMode]: { ...prev[walletMode], ...updates } })); };

            // --- Handlers de Categor√≠as ---
            const handleSaveCategory = () => {
                if (!catForm.name) return;
                if (editingCat) {
                    setCategories(categories.map(c => c.id === editingCat.id ? { ...editingCat, ...catForm } : c));
                    showToast('Categor√≠a actualizada');
                } else {
                    setCategories([...categories, { id: `c-${Date.now()}`, ...catForm }]);
                    showToast('Categor√≠a creada');
                }
                setShowCreateCat(false);
                setEditingCat(null);
                setCatForm({ name: '', icon: 'Star', color: '#6366f1' });
            };

            const handleStartEditCat = (cat) => {
                setEditingCat(cat);
                setCatForm({ name: cat.name, icon: cat.icon, color: cat.color });
                setShowManageCat(false);
                setShowCreateCat(true);
            };

            const handleDeleteCategory = (catId) => {
                const isUsed = transactions.some(t => t.categoryId === catId);
                if (isUsed) {
                    alert('Error: No puedes borrar una categor√≠a que ya est√° en uso en alg√∫n movimiento.');
                    return;
                }
                setCategories(categories.filter(c => c.id !== catId));
                showToast('Categor√≠a eliminada');
            };

            // --- Handlers de Backup/Restauraci√≥n ---
            const handleBackup = () => {
                try {
                    const backupData = {
                        config,
                        transactions,
                        categories,
                        goals,
                        version: 1
                    };
                    const jsonString = JSON.stringify(backupData);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `control_personal_backup_${new Date().toISOString().slice(0,10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast('Backup exportado');
                } catch (err) {
                    alert('Error al exportar el backup: ' + err.message);
                }
            };

            const handleRestore = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data.version || !data.transactions || !data.categories) {
                            throw new Error('Archivo de backup inv√°lido.');
                        }
                        if (confirm('¬øEst√°s seguro? Esto reemplazar√° todos tus datos actuales.')) {
                            setConfig(data.config || null);
                            setTransactions(data.transactions || []);
                            setCategories(data.categories || DEFAULT_CATS);
                            setGoals(data.goals || []);
                            showToast('Backup restaurado');
                        }
                    } catch (err) {
                        alert('Error al importar el backup: ' + err.message);
                    }
                };
                reader.readAsText(file);
                event.target.value = null; // Resetear el input
            };

            // --- COMPONENTES INTERNOS ---
            // (Se mueven aqu√≠ para que tengan acceso al scope de 'App', ej. 'setShowReportModal')

            // --- ¬°CORREGIDO! Componente de Toast ---
            const Toast = ({ message, show }) => {
                return React.createElement('div', { className: `fixed bottom-24 left-1/2 -translate-x-1/2 z-50 bg-slate-900 dark:bg-slate-700 text-white text-sm font-bold py-3 px-5 rounded-full shadow-lg ${show ? 'toast-in' : 'toast-out'} ${!show ? 'opacity-0' : ''}` }, message);
            };

            // --- ¬°CORREGIDO! Componente de Gr√°fico ---
            const StatsTab = () => {
                const chartRef = useRef(null);
                const chartInstance = useRef(null);

                useEffect(() => {
                    if (!chartRef.current) return;

                    const expenseData = categories.map(cat => {
                        const amount = currentData.filter(t => t.type === 'expense' && t.categoryId === cat.id).reduce((sum, t) => sum + Number(t.amount), 0);
                        return { label: cat.name, amount, color: cat.color };
                    }).filter(c => c.amount > 0);

                    if (chartInstance.current) chartInstance.current.destroy();
                    
                    if (expenseData.length === 0) return; // No dibujar si no hay datos

                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: expenseData.map(d => d.label),
                            datasets: [{ 
                                data: expenseData.map(d => d.amount), 
                                backgroundColor: expenseData.map(d => d.color), 
                                borderWidth: 4, 
                                borderColor: darkMode ? '#1e293b' : '#ffffff' 
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            cutout: '70%',
                        }
                    });

                    return () => { if (chartInstance.current) chartInstance.current.destroy(); };
                }, [currentData, categories, darkMode]);

                const totalExpense = expense;

                return React.createElement(Card, { className: "flex flex-col items-center pt-8 pb-8 fade-in" },
                    React.createElement("div", { className: "w-full flex justify-between items-center mb-6" },
                        React.createElement("h3", { className: "font-bold text-slate-800 dark:text-white text-lg" }, "Gastos por Categor√≠a"),
                        // ¬°Ahora 'setShowReportModal' est√° en el scope!
                        React.createElement("button", { onClick: () => setShowReportModal(true), className: "flex items-center gap-2 bg-slate-100 dark:bg-slate-700 px-3 py-1.5 rounded-lg text-xs font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors" },
                            React.createElement(Download, { size: 14 }), "Exportar"
                        )
                    ),
                    totalExpense === 0 ? React.createElement("p", { className: "text-center text-slate-400 text-sm py-10" }, "No hay datos de gastos") :
                    React.createElement(React.Fragment, null,
                        React.createElement("div", { className: "relative w-48 h-48 mb-6" },
                            React.createElement("canvas", { ref: chartRef }),
                            React.createElement("div", { className: "absolute inset-0 flex flex-col items-center justify-center" }, 
                                React.createElement("span", { className: "text-xs text-slate-400" }, "Total Gastado"),
                                React.createElement("span", { className: "font-bold text-2xl text-slate-800 dark:text-white" }, formatCordoba(totalExpense))
                            )
                        ),
                        React.createElement("div", { className: "w-full space-y-2" },
                            categories.map(cat => {
                                const amount = currentData.filter(t => t.type === 'expense' && t.categoryId === cat.id).reduce((sum, t) => sum + Number(t.amount), 0);
                                if(amount === 0) return null;
                                const percent = (amount / totalExpense * 100).toFixed(0);
                                return React.createElement("div", { key: cat.id, className: "flex items-center justify-between text-sm p-3 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700/50" },
                                    React.createElement("div", { className: "flex items-center gap-3" }, 
                                        React.createElement("div", { className: "w-3 h-3 rounded-full", style: { backgroundColor: cat.color } }), 
                                        React.createElement("span", { className: "text-slate-600 dark:text-slate-300" }, cat.name),
                                        React.createElement("span", { className: "text-xs font-bold text-slate-400" }, percent, "%")
                                    ),
                                    React.createElement("span", { className: "font-bold text-slate-700 dark:text-white" }, formatCordoba(amount))
                                );
                            })
                        )
                    )
                );
            };

            // --- FIN COMPONENTES INTERNOS ---


            return React.createElement("div", { className: "min-h-screen" },
                React.createElement("div", { className: "min-h-screen bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 font-sans pb-24 transition-colors duration-300" },

                    /* SETUP (Sin cambios) */
                    !config && React.createElement("div", { className: "min-h-screen flex items-center justify-center p-6 fade-in relative" },
                        React.createElement("button", { onClick: () => setDarkMode(!darkMode), className: "absolute top-6 right-6 p-3 rounded-full bg-white dark:bg-slate-800 shadow-lg border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-200 z-50 active:scale-90 transition-transform" }, darkMode ? React.createElement(Sun, { size: 24 }) : React.createElement(Moon, { size: 24 })),
                        React.createElement("div", { className: "w-full max-w-sm bg-white dark:bg-slate-800/90 backdrop-blur-md rounded-[2rem] p-8 shadow-2xl border border-white/50 dark:border-slate-700" },
                            React.createElement("div", { className: "flex justify-center mb-6" }, React.createElement("div", { className: "bg-blue-600 p-4 rounded-2xl shadow-blue-500/30 shadow-lg" }, React.createElement(ShieldCheck, { className: "text-white", size: 40 }))),
                            React.createElement("h2", { className: "text-2xl font-bold text-center mb-2 text-slate-900 dark:text-white" }, "Crear Cuenta"),
                            React.createElement("div", { className: "space-y-5" },
                                React.createElement("input", { className: "w-full p-4 bg-slate-50 dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 rounded-xl font-bold outline-none focus:border-blue-500 dark:focus:border-blue-500 text-slate-900 dark:text-white", placeholder: "Tu Nombre", value: newUserName, onChange: e => setNewUserName(e.target.value) }),
                                React.createElement("input", { type: "password", maxLength: 4, inputMode: "numeric", className: "w-full p-4 bg-slate-50 dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 rounded-xl font-bold outline-none focus:border-blue-500 dark:focus:border-blue-500 text-slate-900 dark:text-white text-center", placeholder: "PIN (4 d√≠gitos)", value: newUserPin, onChange: e => setNewUserPin(e.target.value) }),
                                React.createElement("input", { type: "password", maxLength: 4, inputMode: "numeric", className: "w-full p-4 bg-slate-50 dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 rounded-xl font-bold outline-none focus:border-blue-500 dark:focus:border-blue-500 text-slate-900 dark:text-white text-center", placeholder: "Confirmar PIN", value: newUserPinConfirm, onChange: e => setNewUserPinConfirm(e.target.value) }),
                                React.createElement("button", { onClick: handleFinishSetup, disabled: !newUserName || newUserPin.length < 4 || newUserPin !== newUserPinConfirm, className: "w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all" }, "Guardar")
                            )
                        )
                    ),

                    /* LOGIN (Sin cambios) */
                    config && !isAuth && React.createElement("div", { className: "min-h-screen flex items-center justify-center p-6 fade-in relative" },
                        React.createElement("button", { onClick: () => setDarkMode(!darkMode), className: "absolute top-6 right-6 p-3 rounded-full bg-white dark:bg-slate-800 shadow-lg border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-200 z-50 active:scale-90 transition-transform" }, darkMode ? React.createElement(Sun, { size: 24 }) : React.createElement(Moon, { size: 24 })),
                        React.createElement("div", { className: "w-full max-w-sm bg-white dark:bg-slate-800/95 backdrop-blur-md rounded-[2rem] p-8 shadow-2xl border border-white/50 dark:border-slate-700" },
                            React.createElement("div", { className: "flex justify-center mb-6" }, React.createElement("div", { className: "bg-slate-100 dark:bg-slate-700 p-4 rounded-2xl shadow-inner" }, React.createElement(Lock, { className: "text-slate-600 dark:text-slate-300", size: 32 }))),
                            React.createElement("h2", { className: "text-2xl font-bold text-center text-slate-800 dark:text-white mb-1" }, "Hola, ", safeConfig.personal?.name || 'Usuario'),
                            React.createElement("form", { onSubmit: handleLogin, className: "space-y-6 mt-8" },
                                React.createElement("input", { type: "password", maxLength: 4, inputMode: "numeric", className: "w-full bg-slate-50 dark:bg-slate-950 border-2 border-slate-200 dark:border-slate-700 rounded-2xl py-5 text-center text-3xl font-bold tracking-[1em] text-slate-800 dark:text-white focus:border-blue-500 outline-none shadow-sm", placeholder: "‚Ä¢‚Ä¢‚Ä¢‚Ä¢", value: pinInput, onChange: (e) => setPinInput(e.target.value) }),
                                errorMsg && React.createElement("p", { className: "text-rose-500 text-xs text-center font-bold bg-rose-50 dark:bg-rose-900/20 p-2 rounded-lg" }, errorMsg),
                                React.createElement("button", { className: "w-full bg-slate-900 dark:bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-transform" }, "Entrar")
                            )
                        )
                    ),

                    /* APP */
                    config && isAuth && React.createElement(React.Fragment, null,
                        React.createElement("header", { className: `${theme.bg} pt-8 pb-20 px-6 rounded-b-[2.5rem] shadow-lg relative overflow-hidden transition-colors duration-500` },
                           React.createElement("div", { className: "relative z-10 flex justify-center mb-6" },
                                React.createElement("div", { className: "bg-black/20 p-1 rounded-full flex backdrop-blur-sm" },
                                    React.createElement("button", { onClick: () => setWalletMode('personal'), className: `px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 transition-all ${walletMode === 'personal' ? 'bg-white text-slate-800 shadow-sm' : 'text-white/70'}` }, React.createElement(User, { size: 14 }), safeConfig.personal?.name || 'M√≠o'),
                                    React.createElement("button", { onClick: () => setWalletMode('partner'), className: `px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 transition-all ${walletMode === 'partner' ? 'bg-white text-slate-800 shadow-sm' : 'text-white/70'}` }, React.createElement(Heart, { size: 14 }), safeConfig.partner?.name || 'Pareja')
                                )
                            ),
                            React.createElement("div", { className: "relative z-10 text-center text-white" },
                                React.createElement("span", { className: "text-white/80 text-xs font-medium uppercase tracking-wider" }, "Saldo Disponible"),
                                React.createElement("h1", { className: "text-5xl font-bold tracking-tight mt-1 mb-6" }, formatCordoba(balance)),
                                React.createElement("div", { className: "flex justify-center gap-3" },
                                    React.createElement("div", { className: "bg-white/10 backdrop-blur-sm px-4 py-2 rounded-xl flex items-center gap-2 border border-white/5" }, React.createElement(TrendingUp, { size: 14, className: "text-emerald-200" }), React.createElement("span", { className: "font-bold text-sm" }, "+", formatCordoba(income))),
                                    React.createElement("div", { className: "bg-white/10 backdrop-blur-sm px-4 py-2 rounded-xl flex items-center gap-2 border border-white/5" }, React.createElement(TrendingDown, { size: 14, className: "text-rose-200" }), React.createElement("span", { className: "font-bold text-sm" }, "-", formatCordoba(expense)))
                                )
                            )
                        ),

                        React.createElement("main", { className: "px-5 -mt-10 relative z-20 space-y-6 pb-24 fade-in" },
                            activeTab === 'home' && React.createElement(React.Fragment, null,
                                React.createElement("div", { className: "grid grid-cols-2 gap-4" },
                                    React.createElement("button", { onClick: () => handleOpenNewTx('income'), className: "bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm flex items-center gap-3 active:scale-95 transition-transform" }, React.createElement("div", { className: "bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 p-3 rounded-full" }, React.createElement(TrendingUp, { size: 20 })), React.createElement("div", { className: "text-left" }, React.createElement("span", { className: "block font-bold text-sm text-slate-700 dark:text-white" }, "Ingreso"))),
                                    React.createElement("button", { onClick: () => handleOpenNewTx('expense'), className: "bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm flex items-center gap-3 active:scale-95 transition-transform" }, React.createElement("div", { className: "bg-rose-50 dark:bg-rose-900/20 text-rose-500 dark:text-rose-400 p-3 rounded-full" }, React.createElement(TrendingDown, { size: 20 })), React.createElement("div", { className: "text-left" }, React.createElement("span", { className: "block font-bold text-sm text-slate-700 dark:text-white" }, "Gasto")))
                                ),
                                React.createElement("div", null,
                                    React.createElement("h3", { className: "font-bold text-slate-500 dark:text-slate-500 text-xs uppercase tracking-wider mb-3 ml-1" }, "Movimientos"),
                                    React.createElement("div", { className: "space-y-3" },
                                        sortedData.slice(0, 15).map(t => {
                                            const cat = categories.find(c => c.id === t.categoryId) || DEFAULT_CATS[0];
                                            return React.createElement(Card, { 
                                                key: t.id, 
                                                className: "!p-3 flex justify-between items-center" 
                                            },
                                                React.createElement("div", { className: "flex items-center gap-4 flex-1 min-w-0" },
                                                    React.createElement("div", { style: { backgroundColor: `${cat.color}20`, color: cat.color }, className: "w-12 h-12 rounded-xl flex items-center justify-center shrink-0" }, 
                                                        React.createElement(IconRenderer, { name: cat.icon })
                                                    ),
                                                    React.createElement("div", { className: "min-w-0" }, 
                                                        React.createElement("p", { className: "font-bold text-sm text-slate-700 dark:text-white" }, cat.name), 
                                                        React.createElement("div", { className: "flex items-center gap-2 text-xs text-slate-400 dark:text-slate-500" }, 
                                                            React.createElement("span", { className: "whitespace-nowrap" }, formatDate(t.date)), 
                                                            t.description && React.createElement("span", { className: "truncate max-w-[80px]" }, "‚Ä¢ ", t.description)
                                                        )
                                                    )
                                                ),
                                                React.createElement("div", { className: "text-right ml-2 shrink-0" }, 
                                                    React.createElement("span", { className: `font-bold text-sm block ${t.type === 'income' ? 'text-emerald-500' : 'text-slate-700 dark:text-slate-300'}` }, t.type === 'income' ? '+' : '-', formatCordoba(t.amount))
                                                ),
                                                React.createElement("button", { 
                                                    onClick: () => handleStartEdit(t), 
                                                    className: "p-2 ml-1 text-slate-400 hover:text-blue-500 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 -mr-2"
                                                }, React.createElement(Edit3, { size: 16 }))
                                            );
                                        })
                                    )
                                )
                            ),
                            
                            activeTab === 'goals' && React.createElement("div", { className: "space-y-4 fade-in" },
                                React.createElement("div", { className: "flex justify-between items-center px-1" }, React.createElement("h3", { className: "font-bold text-slate-700 dark:text-slate-200" }, "Mis Metas"), React.createElement("button", { onClick: () => setShowGoalModal(true), className: `text-xs font-bold px-4 py-2 rounded-lg ${theme.bg} text-white shadow-sm` }, "+ Nueva")),
                                currentGoals.map(g => {
                                    const percent = Math.min(100, Math.round((g.current / g.target) * 100));
                                    return React.createElement(Card, { key: g.id, className: "relative overflow-hidden border-l-4 border-transparent", style: { borderLeftColor: g.color } },
                                        React.createElement("div", { className: "flex justify-between items-end mb-3 relative z-10" },
                                            React.createElement("div", null, React.createElement("h4", { className: "font-bold text-lg text-slate-800 dark:text-white" }, g.name), React.createElement("p", { className: "text-xs text-slate-500 dark:text-slate-400" }, "Meta: ", formatCordoba(g.target))),
                                            React.createElement("div", { className: "text-right" }, React.createElement("span", { className: "text-xl font-bold text-slate-800 dark:text-white" }, formatCordoba(g.current)), React.createElement("span", { className: "block text-[10px] font-bold text-slate-400 uppercase" }, percent, "% logrado"))
                                        ),
                                        React.createElement("div", { className: "w-full bg-slate-100 dark:bg-black h-3 rounded-full overflow-hidden mb-4 relative" }, React.createElement("div", { className: "h-full transition-all duration-700 rounded-full", style: { width: `${percent}%`, backgroundColor: g.color } })),
                                        React.createElement("div", { className: "flex justify-end gap-3 relative z-10 pt-3 border-t border-slate-50 dark:border-slate-700" },
                                            React.createElement("button", { onClick: () => { const input = prompt(`Abonar a ${g.name} (C$):`); const add = Number(input); if (add > 0 && add <= balance) { setGoals(goals.map(x => x.id === g.id ? { ...x, current: x.current + add } : x)); } else if(add>balance) alert("Sin fondos"); }, className: `text-xs font-bold ${theme.text} bg-slate-50 dark:bg-slate-700 px-4 py-2 rounded-lg` }, "Abonar"),
                                            React.createElement("button", { onClick: () => setGoals(goals.filter(x => x.id !== g.id)), className: "p-2 text-slate-400 hover:text-rose-500" }, React.createElement(Trash2, { size: 16 }))
                                        )
                                    );
                                })
                            ),
                            
                            activeTab === 'stats' && React.createElement(StatsTab, null),

                            activeTab === 'profile' && React.createElement("div", { className: "space-y-5 fade-in" },
                                React.createElement(Card, { className: "flex items-center gap-4 bg-slate-800 dark:bg-slate-900 text-white border-none shadow-lg" },
                                    React.createElement("div", { className: "w-16 h-16 bg-white/10 rounded-full flex items-center justify-center text-3xl font-bold border-2 border-white/10" }, currentProfile.gender === 'female' ? React.createElement(UserCircle2, { size: 40 }) : React.createElement(User, { size: 40 })),
                                    React.createElement("div", { className: "flex-1" },
                                        React.createElement("div", { className: "flex items-center gap-2" }, React.createElement("h2", { className: "font-bold text-xl" }, currentProfile.name), React.createElement("button", { onClick: () => { setTempName(currentProfile.name); setShowNameEdit(true); }, className: "p-1 bg-white/10 rounded-full hover:bg-white/20 transition-colors" }, React.createElement(Settings, { size: 12 }))),
                                        React.createElement("p", { className: "text-slate-400 text-xs uppercase tracking-wide" }, "ID: ", walletMode === 'personal' ? 'Propietario' : 'Pareja')
                                    )
                                ),
                                React.createElement("div", { className: "bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm" },
                                    React.createElement("h4", { className: "text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2" }, React.createElement(Palette, { size: 14 }), " Color del Tema"),
                                    React.createElement("div", { className: "flex justify-between gap-2 overflow-x-auto pb-2 scrollbar-hide" }, Object.entries(THEME_COLORS).map(([key, val]) => React.createElement("button", { key, onClick: () => updateProfile({ theme: key }), className: `w-10 h-10 rounded-full flex items-center justify-center transition-all shrink-0 ${val.bg} ${currentProfile.theme === key ? `ring-4 ring-offset-2 ${val.ring} ring-offset-white dark:ring-offset-slate-900 scale-110` : 'opacity-50 hover:opacity-100'}` }, currentProfile.theme === key && React.createElement(Check, { size: 16, className: "text-white" }))))
                                ),
                                React.createElement("div", { className: "bg-white dark:bg-slate-800 rounded-2xl overflow-hidden shadow-sm divide-y divide-slate-100 dark:divide-slate-700" },
                                    React.createElement("div", { className: "p-4 flex items-center justify-between" },
                                        React.createElement("span", { className: "font-medium text-slate-700 dark:text-white text-sm flex items-center gap-3" }, React.createElement(User, { size: 18, className: "text-slate-400" }), " G√©nero"),
                                        React.createElement("div", { className: "flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg" },
                                            React.createElement("button", { onClick: () => updateProfile({ gender: 'male' }), className: `px-3 py-1 rounded-md text-xs font-bold transition-all ${currentProfile.gender === 'male' ? 'bg-white dark:bg-slate-800 shadow text-blue-500' : 'text-slate-400'}` }, "Hombre"),
                                            React.createElement("button", { onClick: () => updateProfile({ gender: 'female' }), className: `px-3 py-1 rounded-md text-xs font-bold transition-all ${currentProfile.gender === 'female' ? 'bg-white dark:bg-slate-800 shadow text-pink-500' : 'text-slate-400'}` }, "Mujer")
                                        )
                                    ),
                                    React.createElement("button", { onClick: () => setDarkMode(!darkMode), className: "w-full p-4 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors" }, React.createElement("span", { className: "font-medium text-slate-700 dark:text-white text-sm flex items-center gap-3" }, React.createElement(Moon, { size: 18, className: "text-slate-400" }), " Modo Oscuro"), React.createElement("div", { className: `w-10 h-6 rounded-full relative transition-colors ${darkMode ? theme.bg : 'bg-slate-200'}` }, React.createElement("div", { className: `absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${darkMode ? 'left-5' : 'left-1'}` }))),
                                    
                                    // --- ¬°NUEVO! Botones de Backup/Restore ---
                                    React.createElement("button", { onClick: handleBackup, className: "w-full p-4 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-700/50 text-blue-500 transition-colors" }, 
                                        React.createElement("span", { className: "font-medium text-sm flex items-center gap-3" }, React.createElement(Download, { size: 18 }), " Exportar Backup (.json)")
                                    ),
                                    React.createElement("button", { onClick: () => fileInputRef.current && fileInputRef.current.click(), className: "w-full p-4 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-700/50 text-emerald-500 transition-colors" }, 
                                        React.createElement("span", { className: "font-medium text-sm flex items-center gap-3" }, React.createElement(Upload, { size: 18 }), " Importar Backup (.json)"),
                                        React.createElement("input", { type: "file", ref: fileInputRef, hidden: true, accept: ".json,application/json", onChange: handleRestore })
                                    ),
                                    
                                    React.createElement("button", { onClick: () => setShowResetConfirm(true), className: "w-full p-4 flex items-center justify-between hover:bg-rose-50 dark:hover:bg-rose-900/10 text-rose-500 transition-colors" }, React.createElement("span", { className: "font-medium text-sm flex items-center gap-3" }, React.createElement(Trash2, { size: 18, className: "text-rose-400" }), " Borrar datos de ", currentProfile.name)),
                                    React.createElement("button", { onClick: () => setIsAuth(false), className: "w-full p-4 flex items-center justify-between text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors" }, React.createElement("span", { className: "font-medium text-sm flex items-center gap-3" }, React.createElement(LogOut, { size: 18 }), " Cerrar Sesi√≥n"))
                                )
                            )
                        ),
                        
                        // NAV (Bot√≥n '+' modificado)
                        React.createElement("nav", { className: "fixed bottom-0 w-full bg-white dark:bg-slate-800 border-t border-slate-100 dark:border-slate-700 pb-safe z-30 transition-colors duration-300" },
                            React.createElement("div", { className: "flex justify-around items-center p-2" },
                                ['home', 'stats', 'plus', 'goals', 'profile'].map(item => {
                                    if (item === 'plus') return React.createElement("div", { key: item, className: "relative -top-6" }, 
                                        React.createElement("button", { onClick: () => handleOpenNewTx('expense'), className: `${theme.bg} text-white p-4 rounded-full shadow-lg active:scale-95 transition-transform border-4 border-slate-50 dark:border-slate-900` }, React.createElement(Plus, { size: 28 }))
                                    );
                                    const Icon = item === 'home' ? LayoutGrid : item === 'stats' ? PieIcon : item === 'goals' ? Target : Settings;
                                    const label = item === 'home' ? 'Inicio' : item === 'stats' ? 'An√°lisis' : item === 'goals' ? 'Metas' : 'Perfil';
                                    return React.createElement("button", { key: item, onClick: () => setActiveTab(item), className: `flex flex-col items-center p-2 rounded-xl transition-colors ${activeTab === item ? `${theme.text} dark:text-white` : 'text-slate-400 dark:text-slate-600'}` }, React.createElement(Icon, { size: 24, strokeWidth: activeTab === item ? 2.5 : 2 }), React.createElement("span", { className: "text-[10px] font-bold mt-1" }, label));
                                })
                            )
                        ),

                        // --- MODAL DE REPORTES ---
                        showReportModal && React.createElement("div", { className: "fixed inset-0 z-50 bg-black/50 flex items-end sm:items-center justify-center fade-in" },
                            React.createElement("div", { className: "bg-white dark:bg-slate-800 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl" },
                                React.createElement("div", { className: "flex justify-between items-center mb-6" }, 
                                    React.createElement("h3", { className: "font-bold text-lg text-slate-800 dark:text-white" }, "Generar Reporte"), 
                                    React.createElement("button", { onClick: () => setShowReportModal(false), className: "p-2 bg-slate-100 dark:bg-slate-700 rounded-full" }, React.createElement(X, { size: 20, className: "text-slate-600 dark:text-white" }))
                                ),
                                React.createElement("div", { className: "space-y-4" },
                                    React.createElement("div", { className: "flex gap-2 overflow-x-auto pb-2 scrollbar-hide" },
                                        [{k:'month', l:'Este Mes'}, {k:'prev_month', l:'Mes Pasado'}, {k:'all', l:'Todo'}, {k:'custom', l:'Rango'}].map(f => 
                                            React.createElement("button", { key: f.k, onClick: () => setReportFilter(f.k), className: `px-4 py-2 rounded-xl font-bold text-xs whitespace-nowrap transition-colors ${reportFilter === f.k ? 'bg-blue-600 text-white' : 'bg-slate-100 dark:bg-slate-700 text-slate-500'}` }, f.l)
                                        )
                                    ),
                                    reportFilter === 'custom' && React.createElement("div", { className: "flex gap-3" },
                                        React.createElement("div", { className: "flex-1" }, React.createElement("label", { className: "text-[10px] font-bold text-slate-400 uppercase ml-1" }, "Desde"), React.createElement("input", { type: "date", className: "w-full p-3 bg-slate-100 dark:bg-slate-700 rounded-xl text-xs font-bold dark:text-white border-2 border-slate-100 dark:border-slate-700", value: customStart, onChange: e => setCustomStart(e.target.value) })),
                                        React.createElement("div", { className: "flex-1" }, React.createElement("label", { className: "text-[10px] font-bold text-slate-400 uppercase ml-1" }, "Hasta"), React.createElement("input", { type: "date", className: "w-full p-3 bg-slate-100 dark:bg-slate-700 rounded-xl text-xs font-bold dark:text-white border-2 border-slate-100 dark:border-slate-700", value: customEnd, onChange: e => setCustomEnd(e.target.value) }))
                                    ),
                                    React.createElement("div", { className: "grid grid-cols-2 gap-3 pt-2" },
                                        React.createElement("button", { onClick: () => { generatePDF(getFilteredDataForReport(), currentProfile.name, reportFilter, categories); setShowReportModal(false); }, className: "flex items-center justify-center gap-2 p-4 bg-rose-500 text-white rounded-xl font-bold hover:bg-rose-600 transition-colors" }, React.createElement(FileText, { size: 20 }), "PDF"),
                                        React.createElement("button", { onClick: () => { generateExcel(getFilteredDataForReport(), currentProfile.name, reportFilter, categories); setShowReportModal(false); }, className: "flex items-center justify-center gap-2 p-4 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 transition-colors" }, React.createElement(FileSpreadsheet, { size: 20 }), "Excel")
                                    )
                                )
                            )
                        ),

                        // --- MODAL DE TRANSACCI√ìN (REDISE√ëADO) ---
                        showTransModal && React.createElement("div", { className: "fixed inset-0 z-50 bg-black/50 flex items-end sm:items-center justify-center fade-in" },
                            React.createElement("div", { className: "bg-white dark:bg-slate-800 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl" },
                                React.createElement("div", { className: "flex justify-between items-center mb-6" }, 
                                    React.createElement("h3", { className: "font-bold text-lg text-slate-800 dark:text-white" }, editingTx ? "Editar Movimiento" : "Nuevo Movimiento"), 
                                    React.createElement("button", { onClick: () => { setShowTransModal(false); resetTransForm(); }, className: "p-2 bg-slate-100 dark:bg-slate-700 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600" }, React.createElement(X, { size: 20, className: "text-slate-600 dark:text-white" }))
                                ),
                                formError && React.createElement("div", { className: "mb-4 p-3 bg-rose-100 dark:bg-rose-900/30 border border-rose-200 dark:border-rose-800 rounded-xl flex items-center gap-3" }, React.createElement(Ban, { className: "text-rose-500 shrink-0", size: 20 }), React.createElement("span", { className: "text-xs font-bold text-rose-600 dark:text-rose-400" }, formError)),
                                React.createElement("div", { className: "space-y-4" },
                                    React.createElement("div", { className: "flex bg-slate-100 dark:bg-slate-900 p-1 rounded-xl" },
                                        React.createElement("button", { onClick: () => { setTransForm({ ...transForm, type: 'income' }); setFormError(''); }, className: `flex-1 py-2 rounded-lg font-bold text-sm transition-colors ${transForm.type === 'income' ? 'bg-white dark:bg-slate-700 text-emerald-500 shadow-sm' : 'text-slate-400'}` }, "Ingreso"),
                                        React.createElement("button", { onClick: () => { setTransForm({ ...transForm, type: 'expense' }); setFormError(''); }, className: `flex-1 py-2 rounded-lg font-bold text-sm transition-colors ${transForm.type === 'expense' ? 'bg-white dark:bg-slate-700 text-rose-500 shadow-sm' : 'text-slate-400'}` }, "Gasto")
                                    ),
                                    React.createElement("div", { className: "relative" }, 
                                        React.createElement("span", { className: `absolute top-1/2 -translate-y-1/2 left-4 text-2xl font-bold ${formError ? 'text-rose-300' : 'text-slate-400'}` }, "C$"), 
                                        React.createElement("input", { type: "number", inputMode: "numeric", placeholder: "0", className: `w-full pl-12 pr-4 py-4 text-4xl font-bold text-center bg-slate-100 dark:bg-slate-900 rounded-xl outline-none transition-colors border-2 ${formError ? 'text-rose-500 border-rose-500 bg-rose-50 dark:bg-rose-900/10' : 'text-slate-800 dark:text-white border-slate-100 dark:border-slate-800 focus:border-blue-500'}`, value: transForm.amount, onChange: e => { setTransForm({ ...transForm, amount: e.target.value }); setFormError(''); } })
                                    ),
                                    React.createElement("div", { className: "flex items-center gap-3 bg-slate-100 dark:bg-slate-900 p-3 rounded-xl border-2 border-slate-100 dark:border-slate-800" }, 
                                        React.createElement(Clock, { size: 20, className: "text-slate-400" }), 
                                        React.createElement("input", { type: "datetime-local", className: "bg-transparent outline-none w-full font-bold text-slate-700 dark:text-white text-sm", value: transForm.date, onChange: e => setTransForm({ ...transForm, date: e.target.value }) })
                                    ),
                                    React.createElement("button", { onClick: () => setShowCatModal(true), className: "w-full p-4 bg-slate-100 dark:bg-slate-900 border-2 border-slate-100 dark:border-slate-800 rounded-xl flex justify-between items-center hover:border-slate-300 dark:hover:border-slate-700 transition-colors" }, 
                                        transForm.categoryId ? React.createElement("div", { className: "flex items-center gap-3" }, (() => { const c = categories.find(x => x.id === transForm.categoryId); return c ? React.createElement(React.Fragment, null, React.createElement("div", { style: { color: c.color } }, React.createElement(IconRenderer, { name: c.icon, size: 24 })), React.createElement("span", { className: "font-bold text-slate-700 dark:text-white" }, c.name)) : 'Error'; })()) 
                                                        : React.createElement("span", { className: "text-slate-400 font-medium" }, "Seleccionar Categor√≠a"), 
                                        React.createElement(ChevronRight, { size: 20, className: "text-slate-400" })
                                    ),
                                    React.createElement("input", { placeholder: "Nota (Opcional)", className: "w-full p-4 bg-slate-100 dark:bg-slate-900 border-2 border-slate-100 dark:border-slate-800 rounded-xl outline-none text-slate-800 dark:text-white placeholder-slate-400 focus:border-blue-500 transition-colors", value: transForm.desc, onChange: e => setTransForm({ ...transForm, desc: e.target.value }) }),
                                    
                                    React.createElement("div", { className: "flex gap-3 pt-2" },
                                        editingTx && React.createElement("button", { onClick: handleDeleteTrans, className: "p-4 bg-slate-100 dark:bg-slate-700 text-rose-500 rounded-xl" },
                                            React.createElement(Trash2, { size: 24 })
                                        ),
                                        React.createElement("button", { onClick: handleSaveTrans, className: `w-full py-4 rounded-xl text-white font-bold text-lg shadow-md active:scale-95 transition-transform ${transForm.type === 'income' ? 'bg-emerald-500' : 'bg-rose-500'}` }, 
                                            editingTx ? "Actualizar" : "Guardar"
                                        )
                                    )
                                )
                            )
                        ),
                        
                        // --- MODAL ELEGIR CATEGOR√çA (con bot√≥n de Gestionar) ---
                        showCatModal && React.createElement("div", { className: "fixed inset-0 z-50 bg-black/50 flex items-end sm:items-center justify-center fade-in" },
                            React.createElement("div", { className: "bg-white dark:bg-slate-800 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 max-h-[80vh] overflow-y-auto shadow-2xl" },
                                React.createElement("div", { className: "flex justify-between items-center mb-6" }, React.createElement("h3", { className: "font-bold text-lg text-slate-800 dark:text-white" }, "Elige Categor√≠a"), React.createElement("button", { onClick: () => setShowCatModal(false), className: "p-2 bg-slate-100 dark:bg-slate-700 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600" }, React.createElement(X, { size: 20, className: "text-slate-600 dark:text-white" }))),
                                React.createElement("div", { className: "grid grid-cols-3 gap-3" },
                                    categories.map(c => React.createElement("button", { key: c.id, onClick: () => { setTransForm({ ...transForm, categoryId: c.id }); setShowCatModal(false); }, className: "flex flex-col items-center gap-2 p-3 rounded-2xl border border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors" }, React.createElement("div", { style: { color: c.color }, className: "bg-slate-50 dark:bg-slate-700/50 p-3 rounded-full" }, React.createElement(IconRenderer, { name: c.icon, size: 24 })), React.createElement("span", { className: "text-xs font-bold text-slate-600 dark:text-slate-300" }, c.name))),
                                    React.createElement("button", { onClick: () => { setShowCatModal(false); setEditingCat(null); setCatForm({ name: '', icon: 'Star', color: '#6366f1' }); setShowCreateCat(true); }, className: "flex flex-col items-center gap-2 p-3 rounded-2xl border-2 border-dashed border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700" }, React.createElement("div", { className: "bg-slate-100 dark:bg-slate-700 p-3 rounded-full text-slate-400" }, React.createElement(Plus, { size: 24 })), React.createElement("span", { className: "text-xs font-bold text-slate-400" }, "Nueva")),
                                    React.createElement("button", { onClick: () => { setShowCatModal(false); setShowManageCat(true); }, className: "flex flex-col items-center gap-2 p-3 rounded-2xl border-2 border-dashed border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700" }, React.createElement("div", { className: "bg-slate-100 dark:bg-slate-700 p-3 rounded-full text-slate-400" }, React.createElement(Settings, { size: 24 })), React.createElement("span", { className: "text-xs font-bold text-slate-400" }, "Gestionar"))
                                )
                            )
                        ),
                        
                        // --- MODAL CREAR/EDITAR CATEGOR√çA ---
                        showCreateCat && React.createElement("div", { className: "fixed inset-0 z-50 bg-black/50 flex items-end sm:items-center justify-center fade-in" },
                            React.createElement("div", { className: "bg-white dark:bg-slate-800 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl" },
                                React.createElement("h3", { className: "font-bold text-lg mb-4 text-slate-800 dark:text-white" }, editingCat ? "Editar Categor√≠a" : "Crear Categor√≠a"),
                                React.createElement("div", { className: "space-y-4" },
                                    React.createElement("input", { placeholder: "Nombre", autoFocus: true, className: "w-full p-4 bg-slate-100 dark:bg-slate-900 rounded-xl border-2 border-slate-100 dark:border-slate-800 outline-none font-bold text-slate-800 dark:text-white placeholder-slate-400 focus:border-blue-500", value: catForm.name, onChange: e => setCatForm({ ...catForm, name: e.target.value }) }),
                                    React.createElement("div", { className: "flex gap-2 overflow-x-auto pb-2 scrollbar-hide" }, Object.keys(ICON_MAP).map(k => React.createElement("button", { key: k, onClick: () => setCatForm({ ...catForm, icon: k }), className: `p-3 rounded-xl shrink-0 transition-colors ${catForm.icon === k ? 'bg-indigo-600 text-white' : 'bg-slate-100 dark:bg-slate-700 text-slate-400'}` }, React.createElement(IconRenderer, { name: k })))),
                                    React.createElement("div", { className: "flex gap-3 overflow-x-auto pb-2 scrollbar-hide" }, ['#ef4444', '#f97316', '#f59e0b', '#10b981', '#3b82f6', '#6366f1', '#ec4899'].map(c => React.createElement("button", { key: c, onClick: () => setCatForm({ ...catForm, color: c }), style: { backgroundColor: c }, className: `w-10 h-10 rounded-full shrink-0 transition-transform ${catForm.color === c ? 'scale-110 ring-2 ring-slate-400' : ''}` }))),
                                    React.createElement("div", { className: "flex gap-2 pt-2" },
                                        React.createElement("button", { onClick: () => { setShowCreateCat(false); setEditingCat(null); }, className: "flex-1 py-3 rounded-xl font-bold text-slate-500 bg-slate-100 dark:bg-slate-700" }, "Cancelar"),
                                        React.createElement("button", { onClick: handleSaveCategory, className: "flex-1 py-3 rounded-xl font-bold text-white bg-indigo-500 shadow-md" }, editingCat ? "Actualizar" : "Crear")
                                    )
                                )
                            )
                        ),

                        // --- ¬°NUEVO! MODAL GESTIONAR CATEGOR√çAS ---
                        showManageCat && React.createElement("div", { className: "fixed inset-0 z-50 bg-black/50 flex items-end sm:items-center justify-center fade-in" },
                            React.createElement("div", { className: "bg-white dark:bg-slate-800 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 max-h-[80vh] overflow-y-auto shadow-2xl" },
                                React.createElement("div", { className: "flex justify-between items-center mb-6" }, 
                                    React.createElement("h3", { className: "font-bold text-lg text-slate-800 dark:text-white" }, "Gestionar Categor√≠as"), 
                                    React.createElement("button", { onClick: () => setShowManageCat(false), className: "p-2 bg-slate-100 dark:bg-slate-700 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600" }, React.createElement(X, { size: 20, className: "text-slate-600 dark:text-white" }))
                                ),
                                React.createElement("div", { className: "space-y-2" },
                                    categories.map(c => React.createElement("div", { key: c.id, className: "flex items-center justify-between p-3 rounded-2xl border border-slate-100 dark:border-slate-700" },
                                        React.createElement("div", { className: "flex items-center gap-3" },
                                            React.createElement("div", { style: { color: c.color } }, React.createElement(IconRenderer, { name: c.icon, size: 24 })),
                                            React.createElement("span", { className: "font-bold text-slate-700 dark:text-white" }, c.name)
                                        ),
                                        React.createElement("div", { className: "flex gap-2" },
                                            React.createElement("button", { onClick: () => handleStartEditCat(c), className: "p-2 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded-lg" }, React.createElement(Edit3, { size: 16 })),
                                            React.createElement("button", { onClick: () => handleDeleteCategory(c.id), className: "p-2 bg-rose-50 dark:bg-rose-900/20 text-rose-500 rounded-lg" }, React.createElement(Trash2, { size: 16 }))
                                        )
                                    ))
                                )
                            )
                        ),

                        // --- MODAL DE METAS ---
                        showGoalModal && React.createElement("div", { /* ... */ }),
                        
                        // --- MODAL EDITAR NOMBRE ---
                        showNameEdit && React.createElement("div", { /* ... */ }),
                        
                        // --- MODAL RESETEAR PERFIL ---
                        showResetConfirm && React.createElement("div", { /* ... */ }),

                        // --- ¬°NUEVO! TOAST NOTIFICATION ---
                        React.createElement(Toast, { message: toast?.message, show: !!toast })
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>

