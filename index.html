<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control Personal</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#2563eb">

    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0iIzI1NjNlYiIvPjxwYXRoIGQ9Ik0xMjggMTc2djE2MGMwIDE3LjcgMTQuMyAzMiAzMiAzMmgxOTJjMTcuNyAwIDMyLTE0LjMgMzItMzJ2LTE2MGMwLTE3LjctMTQuMy0zMi0zMi0zMkgxNjBjLTE3LjcgMC0zMiAxNC4zLTMyIDMyem0zMi0xMGgxOTJjNS45IDAgMTAgNC41IDEwIDEwdjE2MGMwIDUuNS00LjUgMTAtMTAgMTBIMTYwYy01LjUgMC0xMC00LjUtMTAtMTBWMTc2YzAtNS41IDQuNS0xMCAxMC0xMHoiIGZpbGw9IndoaXRlIi8+PHBhdGggZD0iTTMyMCAyNTZoMzJ2MzJoLTMyeiIgZmlsbD0id2hpdGUiLz48cGF0aCBkPSJNMTQwIDE0MGgyMzIiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMzAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvc3ZnPg==">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0iIzI1NjNlYiIvPjxwYXRoIGQ9Ik0xMjggMTc2djE2MGMwIDE3LjcgMTQuMyAzMiAzMiAzMmgxOTJjMTcuNyAwIDMyLTE0LjMgMzItMzJ2LTE2MGMwLTE3LjctMTQuMy0zMi0zMi0zMkgxNjBjLTE3LjcgMC0zMiAxNC4zLTMyIDMyem0zMi0xMGgxOTJjNS45IDAgMTAgNC41IDEwIDEwdjE2MGMwIDUuNS00LjUgMTAtMTAgMTBIMTYwYy01LjUgMC0xMC00LjUtMTAtMTBWMTc2YzAtNS41IDQuNS0xMCAxMC0xMHoiIGZpbGw9IndoaXRlIi8+PHBhdGggZD0iTTMyMCAyNTZoMzJ2MzJoLTMyeiIgZmlsbD0id2hpdGUiLz48cGF0aCBkPSJNMTQwIDE0MGgyMzIiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMzAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvc3ZnPg==">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { slate: { 850: '#1e293b', 900: '#0f172a' } }, fontFamily: { sans: ['system-ui', '-apple-system', 'sans-serif'] } } }
        }
    </script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-tap-highlight-color: transparent; user-select: none; overscroll-behavior-y: none; }
        input, textarea { user-select: text; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .toast-in { animation: toastIn 0.3s ease-out forwards; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .toast-out { animation: toastOut 0.3s ease-in forwards; }
        @keyframes toastOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(20px); } }
        #loading-screen { position: fixed; inset: 0; background: #0f172a; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 9999; transition: opacity 0.5s; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-950 text-slate-800 h-screen overflow-hidden select-none transition-colors duration-300">
    
    <div id="loading-screen">
        <div class="text-4xl mb-4">üìÇ</div>
        <h2 class="text-xl font-bold">Control Personal</h2>
        <p class="text-sm text-slate-400 mt-2">Cargando Sistema...</p>
    </div>

    <div id="root" class="h-full overflow-y-auto scrollbar-hide"></div>

    <script>
        window.onerror = function(msg, url, line) {
            const loader = document.getElementById('loading-screen');
            if(loader) {
                loader.innerHTML = `<div style="padding:20px;text-align:center;color:#ff6b6b;"><h3>‚ö†Ô∏è Error</h3><p>${msg}</p></div>`;
            }
        };
        // REGISTRO DEL SERVICE WORKER (CLAVE PARA PWA)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { 
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registrado!', reg))
                    .catch(err => console.log('SW fall√≥', err)); 
            });
        }
    </script>

    <script typeR="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Wallet, Plus, X, ChevronRight, Lock, LogOut, 
            LayoutGrid, PieChart as PieIcon, Settings, Trash2, 
            ShoppingBag, Coffee, Car, Home, Zap, Heart, Briefcase, 
            Smartphone, Plane, Gift, Music, Book, Smile, Star, 
            TrendingUp, TrendingDown, Target, Sun, Moon, User, 
            RefreshCcw, UserCircle2, Palette, Check, AlertTriangle,
            Clock, ShieldCheck, Ban, FileText, Download, Calendar, FileSpreadsheet,
            Upload, Edit3, Save, MoreVertical, AlertCircle
        } from 'https://esm.sh/lucide-react@0.263.1';

        setTimeout(() => {
            const loader = document.getElementById('loading-screen');
            if(loader) { loader.style.opacity = '0'; setTimeout(() => loader.remove(), 500); }
        }, 1000);

        const ICON_MAP = { ShoppingBag, Coffee, Car, Home, Zap, Heart, Briefcase, Smartphone, Plane, Gift, Music, Book, Smile, Star, Target, User, Wallet, FileText };
        
        const THEME_COLORS = {
            blue:   { name: 'Azul',   bg: 'bg-blue-600',   text: 'text-blue-600',   ring: 'ring-blue-400' },
            indigo: { name: '√çndigo', bg: 'bg-indigo-500', text: 'text-indigo-500', ring: 'ring-indigo-400' },
            emerald:{ name: 'Verde',  bg: 'bg-emerald-600',text: 'text-emerald-600',ring: 'ring-emerald-400' },
            orange: { name: 'Naranja',bg: 'bg-orange-500', text: 'text-orange-500', ring: 'ring-orange-400' },
            rose:   { name: 'Rosa',   bg: 'bg-rose-500',   text: 'text-rose-500',   ring: 'ring-rose-400' },
            slate:  { name: 'Negro',  bg: 'bg-slate-700',  text: 'text-slate-700',  ring: 'ring-slate-400' },
        };

        const DEFAULT_CATS = [
            { id: 'c1', name: 'Comida', icon: 'Coffee', color: '#F59E0B' },
            { id: 'c2', name: 'Transporte', icon: 'Car', color: '#3B82F6' },
            { id: 'c3', name: 'Casa', icon: 'Home', color: '#10B981' },
            { id: 'c4', name: 'Ocio', icon: 'Smile', color: '#EC4899' },
        ];

        // --- HOOKS DE UTILIDAD ---
        const useLocalStorage = (key, fallback) => {
            const [value, setValue] = useState(() => {
                try { const item = localStorage.getItem(key); return item ? JSON.parse(item) : fallback; } catch (e) { return fallback; }
            });
            useEffect(() => {
                try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { console.error(`Error guardando ${key} en localStorage`, e); }
            }, [key, value]);
            return [value, setValue];
        };
        
        // --- FORMATTERS ---
        const formatCordoba = (amount) => new Intl.NumberFormat('es-NI', { style: 'currency', currency: 'NIO', maximumFractionDigits: 0 }).format(amount);
        const formatDate = (isoString) => { 
            if (!isoString) return ''; 
            const date = new Date(isoString); 
            return date.toLocaleDateString('es-NI', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' }); 
        };
        const getNowInput = () => { const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); return now.toISOString().slice(0, 16); };

        // --- COMPONENTES UI ---
        const Card = ({ children, className = "", onClick }) => React.createElement('div', { onClick, className: `bg-white dark:bg-slate-850 p-5 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm ${className}` }, children);
        const IconRenderer = ({ name, size = 20, className }) => { const Icon = ICON_MAP[name] || Star; return React.createElement(Icon, { size, className }); };

        const Toast = ({ message, show, onDismiss }) => {
            useEffect(() => {
                if (show) { const timer = setTimeout(onDismiss, 2000); return () => clearTimeout(timer); }
            }, [show, onDismiss]);
            return React.createElement('div', { className: `fixed bottom-24 left-1/2 -translate-x-1/2 z-50 bg-slate-900 dark:bg-slate-700 text-white text-sm font-bold py-3 px-5 rounded-full shadow-lg ${show ? 'toast-in' : 'toast-out'}` }, message);
        };

        const StatsTab = ({ data, categories, darkMode }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (data.length === 0 || !chartRef.current) return;

                const expenseData = categories.map(cat => {
                    const amount = data.filter(t => t.type === 'expense' && t.categoryId === cat.id).reduce((sum, t) => sum + Number(t.amount), 0);
                    return { label: cat.name, amount, color: cat.color };
                }).filter(c => c.amount > 0);

                if (chartInstance.current) chartInstance.current.destroy();

                const ctx = chartRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: expenseData.map(d => d.label),
                        datasets: [{ data: expenseData.map(d => d.amount), backgroundColor: expenseData.map(d => d.color), borderWidth: 2, borderColor: darkMode ? '#1e293b' : '#ffffff' }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        cutout: '70%',
                    }
                });

                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [data, categories, darkMode]);

            const totalExpense = data.filter(t => t.type === 'expense').reduce((a, b) => a + Number(b.amount), 0);

            return React.createElement(Card, { className: "flex flex-col items-center pt-8 pb-8 fade-in" },
                React.createElement("div", { className: "w-full flex justify-between items-center mb-6" },
                    React.createElement("h3", { className: "font-bold text-slate-800 dark:text-white" }, "Gastos por Categor√≠a"),
                    React.createElement("button", { onClick: () => setShowReportModal(true), className: "flex items-center gap-2 bg-slate-100 dark:bg-slate-800 px-3 py-1.5 rounded-lg text-xs font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors" },
                        React.createElement(Download, { size: 14 }), "Exportar"
                    )
                ),
                totalExpense === 0 ? React.createElement("p", { className: "text-center text-slate-400 text-sm py-10" }, "No hay datos de gastos") :
                React.createElement(React.Fragment, null,
                    React.createElement("div", { className: "relative w-48 h-48 mb-6" },
                        React.createElement("canvas", { ref: chartRef }),
                        React.createElement("div", { className: "absolute inset-0 flex flex-col items-center justify-center" }, 
                            React.createElement("span", { className: "text-xs text-slate-400" }, "Total"),
                            React.createElement("span", { className: "font-bold text-2xl text-slate-800 dark:text-white" }, formatCordoba(totalExpense))
                        )
                    ),
                    React.createElement("div", { className: "w-full space-y-2" },
                        categories.map(cat => {
                            const amount = data.filter(t => t.type === 'expense' && t.categoryId === cat.id).reduce((sum, t) => sum + Number(t.amount), 0);
                            if(amount === 0) return null;
                            const percent = (amount / totalExpense * 100).toFixed(0);
                            return React.createElement("div", { key: cat.id, className: "flex items-center justify-between text-sm p-2 rounded-lg" },
                                React.createElement("div", { className: "flex items-center gap-3" }, 
                                    React.createElement("div", { className: "w-3 h-3 rounded-full", style: { backgroundColor: cat.color } }), 
                                    React.createElement("span", { className: "text-slate-600 dark:text-slate-300" }, cat.name),
                                    React.createElement("span", { className: "text-xs font-bold text-slate-400" }, percent, "%")
                                ),
                                React.createElement("span", { className: "font-bold text-slate-700 dark:text-white" }, formatCordoba(amount))
                            );
                        })
                    )
                )
            );
        };

        // --- FUNCIONES DE REPORTE ---
        const generatePDF = (data, profileName, rangeName, categories) => { /* ... (Sin cambios) ... */ };
        const generateExcel = (data, profileName, rangeName, categories) => { /* ... (Sin cambios) ... */ };
        
        function App() {
            // --- STATE ---
            const [config, setConfig] = useLocalStorage('ew_ctrl_config', null);
            const [darkMode, setDarkMode] = useLocalStorage('ew_dark_mode', true);
            const [isAuth, setIsAuth] = useState(false);
            const [pinInput, setPinInput] = useState('');
            const [errorMsg, setErrorMsg] = useState('');
            const [newUserName, setNewUserName] = useState('');
            const [newUserPin, setNewUserPin] = useState('');
            const [newUserPinConfirm, setNewUserPinConfirm] = useState('');
            const [transactions, setTransactions] = useLocalStorage('ew_ctrl_trans', []);
            const [categories, setCategories] = useLocalStorage('ew_ctrl_cats', DEFAULT_CATS);
            const [goals, setGoals] = useLocalStorage('ew_ctrl_goals', []);
            const [walletMode, setWalletMode] = useState('personal');
            const [activeTab, setActiveTab] = useState('home');
            
            // --- MODAL STATE ---
            const [showTransModal, setShowTransModal] = useState(false);
            const [showCatModal, setShowCatModal] = useState(false);
            const [showCreateCat, setShowCreateCat] = useState(false);
            const [showGoalModal, setShowGoalModal] = useState(false);
            const [showNameEdit, setShowNameEdit] = useState(false);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [showReportModal, setShowReportModal] = useState(false);
            const [showManageCat, setShowManageCat] = useState(false);
            const [editingCat, setEditingCat] = useState(null);
            
            // --- FORM STATE ---
            const [formError, setFormError] = useState('');
            const [tempName, setTempName] = useState('');
            const [reportFilter, setReportFilter] = useState('month');
            const [customStart, setCustomStart] = useState('');
            const [customEnd, setCustomEnd] = useState('');
            const [transForm, setTransForm] = useState({ amount: '', desc: '', type: 'expense', categoryId: null, date: getNowInput() });
            const [catForm, setCatForm] = useState({ name: '', icon: 'Star', color: '#6366f1' });
            const [goalForm, setGoalForm] = useState({ name: '', target: '' });
            
            // --- NUEVO STATE PARA MEJORAS ---
            const [editingTx, setEditingTx] = useState(null); // Guarda la Tx que se est√° editando
            const [toast, setToast] = useState(null); // { message: 'Hola' }

            const fileInputRef = useRef(null); // Para el bot√≥n de importar

            // --- EFECTOS ---
            useEffect(() => {
                if (config) {
                    let fixed = false;
                    const newConfig = { ...config };
                    if (!newConfig.personal) { newConfig.personal = { name: 'M√≠o', theme: 'blue', gender: 'male' }; fixed = true; }
                    if (!newConfig.partner) { newConfig.partner = { name: 'Pareja', theme: 'rose', gender: 'female' }; fixed = true; }
                    if (fixed) setConfig(newConfig);
                }
            }, [config]);

            useEffect(() => {
                document.documentElement.classList.toggle('dark', darkMode);
            }, [darkMode]);

            // --- C√ÅLCULOS DERIVADOS ---
            const safeConfig = config || { personal: { name: 'Usuario' }, partner: { name: 'Pareja' } };
            const currentProfile = safeConfig[walletMode] || (walletMode === 'personal' ? { name: 'M√≠o', theme: 'blue' } : { name: 'Pareja', theme: 'rose' });
            const theme = THEME_COLORS[currentProfile.theme] || THEME_COLORS.blue;
            
            const currentData = transactions.filter(t => t.walletMode === walletMode);
            const currentGoals = goals.filter(g => g.walletMode === walletMode);
            const income = currentData.filter(t => t.type === 'income').reduce((acc, t) => acc + (Number(t.amount) || 0), 0);
            const expense = currentData.filter(t => t.type === 'expense').reduce((acc, t) => acc + (Number(t.amount) || 0), 0);
            const balance = income - expense;
            const sortedData = [...currentData].sort((a, b) => new Date(b.date) - new Date(a.date));

            // --- HANDLERS (L√≥gica de la App) ---

            const showToast = (message) => { setToast({ message }); };

            const getFilteredDataForReport = () => { /* ... (Sin cambios) ... */ };

            const handleFinishSetup = () => { /* ... (Sin cambios) ... */ };

            const handleLogin = (e) => { /* ... (Sin cambios) ... */ };

            const resetTransForm = () => {
                setTransForm({ amount: '', desc: '', type: 'expense', categoryId: null, date: getNowInput() });
                setEditingTx(null);
                setFormError('');
            };

            const handleOpenNewTx = (type = 'expense') => {
                resetTransForm();
                setTransForm(prev => ({ ...prev, type }));
                setShowTransModal(true);
            };

            const handleStartEdit = (tx) => {
                setFormError('');
                setEditingTx(tx);
                setTransForm({
                    amount: tx.amount,
                    desc: tx.description,
                    type: tx.type,
                    categoryId: tx.categoryId,
                    date: tx.date.slice(0, 16) // Ajustar formato para datetime-local
                });
                setShowTransModal(true);
            };

            const handleSaveTrans = () => {
                setFormError('');
                const amount = Number(transForm.amount);
                if (!amount || amount <= 0) { setFormError('Monto inv√°lido'); return; }
                if (!transForm.categoryId) { setFormError('Elige categor√≠a'); return; }
                
                if (editingTx) {
                    // --- L√ìGICA DE ACTUALIZACI√ìN ---
                    const newBalance = (balance - Number(editingTx.amount)) + Number(amount);
                    if (transForm.type === 'expense' && amount > (income - (expense - Number(editingTx.amount)))) { setFormError('Fondos insuficientes'); return; }
                    
                    const updatedTx = { ...editingTx, 
                        amount: Number(amount), 
                        description: transForm.desc || '', 
                        type: transForm.type, 
                        categoryId: transForm.categoryId, 
                        date: transForm.date || new Date().toISOString() 
                    };
                    setTransactions(transactions.map(t => t.id === editingTx.id ? updatedTx : t));
                    showToast('Movimiento actualizado');
                } else {
                    // --- L√ìGICA DE CREACI√ìN ---
                    if (transForm.type === 'expense' && amount > balance) { setFormError('Fondos insuficientes'); return; }
                    const newTx = { 
                        id: Date.now().toString(), walletMode, 
                        amount: Number(amount), 
                        description: transForm.desc || '', 
                        type: transForm.type, 
                        categoryId: transForm.categoryId, 
                        date: transForm.date || new Date().toISOString() 
                    };
                    setTransactions([newTx, ...transactions]);
                    showToast(transForm.type === 'expense' ? 'Gasto guardado' : 'Ingreso guardado');
                }
                
                setShowTransModal(false);
                resetTransForm();
            };

            const handleDeleteTrans = () => {
                if (!editingTx) return;
                setTransactions(transactions.filter(t => t.id !== editingTx.id));
                setShowTransModal(false);
                resetTransForm();
                showToast('Movimiento eliminado');
            };

            const handleResetProfileData = () => { /* ... (Sin cambios) ... */ };

            const updateProfile = (updates) => { /* ... (Sin cambios) ... */ };

            // --- Handlers de Categor√≠as ---
            const handleSaveCategory = () => {
                if (!catForm.name) return;
                if (editingCat) {
                    setCategories(categories.map(c => c.id === editingCat.id ? { ...editingCat, ...catForm } : c));
                    showToast('Categor√≠a actualizada');
                } else {
                    setCategories([...categories, { id: `c-${Date.now()}`, ...catForm }]);
                    showToast('Categor√≠a creada');
                }
                setShowCreateCat(false);
                setEditingCat(null);
                setCatForm({ name: '', icon: 'Star', color: '#6366f1' });
            };

            const handleStartEditCat = (cat) => {
                setEditingCat(cat);
                setCatForm({ name: cat.name, icon: cat.icon, color: cat.color });
                setShowManageCat(false);
                setShowCreateCat(true);
            };

            const handleDeleteCategory = (catId) => {
                const isUsed = transactions.some(t => t.categoryId === catId);
                if (isUsed) {
                    alert('Error: No puedes borrar una categor√≠a que ya est√° en uso en alg√∫n movimiento.');
                    return;
                }
                setCategories(categories.filter(c => c.id !== catId));
                showToast('Categor√≠a eliminada');
            };

            // --- Handlers de Backup/Restauraci√≥n ---
            const handleBackup = () => {
                try {
                    const backupData = {
                        config,
                        transactions,
                        categories,
                        goals,
                        version: 1
                    };
                    const jsonString = JSON.stringify(backupData);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `control_personal_backup_${new Date().toISOString().slice(0,10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast('Backup exportado');
                } catch (err) {
                    alert('Error al exportar el backup: ' + err.message);
                }
            };

            const handleRestore = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data.version || !data.transactions || !data.categories) {
                            throw new Error('Archivo de backup inv√°lido.');
                        }
                        if (confirm('¬øEst√°s seguro? Esto reemplazar√° todos tus datos actuales.')) {
                            setConfig(data.config || null);
                            setTransactions(data.transactions || []);
                            setCategories(data.categories || DEFAULT_CATS);
                            setGoals(data.goals || []);
                            showToast('Backup restaurado');
                        }
                    } catch (err) {
                        alert('Error al importar el backup: ' + err.message);
                    }
                };
                reader.readAsText(file);
                event.target.value = null; // Resetear el input
            };

            return React.createElement("div", { className: darkMode ? "dark" : "" },
                React.createElement("div", { className: "min-h-screen bg-gradient-to-b from-slate-100 to-slate-200 dark:from-slate-900 dark:to-black text-slate-800 dark:text-slate-200 font-sans pb-24 transition-colors duration-300" },

                    /* ... (Sin cambios: SETUP, LOGIN) ... */
                    
                    /* APP */
                    config && isAuth && React.createElement(React.Fragment, null,
                        React.createElement("header", { /* ... (Sin cambios) ... */ }),

                        React.createElement("main", { className: "px-5 -mt-10 relative z-20 space-y-6 pb-24 fade-in" },
                            activeTab === 'home' && React.createElement(React.Fragment, null,
                                React.createElement("div", { className: "grid grid-cols-2 gap-4" },
                                    React.createElement("button", { onClick: () => handleOpenNewTx('income'), className: "bg-white dark:bg-slate-850 p-4 rounded-2xl shadow-sm flex items-center gap-3 active:scale-95 transition-transform border border-slate-100 dark:border-slate-800" }, /* ... (Icono Ingreso) ... */),
                                    React.createElement("button", { onClick: () => handleOpenNewTx('expense'), className: "bg-white dark:bg-slate-850 p-4 rounded-2xl shadow-sm flex items-center gap-3 active:scale-95 transition-transform border border-slate-100 dark:border-slate-800" }, /* ... (Icono Gasto) ... */)
                                ),
                                React.createElement("div", null,
                                    React.createElement("h3", { className: "font-bold text-slate-500 dark:text-slate-500 text-xs uppercase tracking-wider mb-3 ml-1" }, "Movimientos"),
                                    React.createElement("div", { className: "space-y-3" },
                                        sortedData.slice(0, 15).map(t => {
                                            const cat = categories.find(c => c.id === t.categoryId) || DEFAULT_CATS[0];
                                            return React.createElement(Card, { 
                                                key: t.id, 
                                                onClick: () => handleStartEdit(t), // <-- A√ëADIDO: Clic para editar
                                                className: "!p-3 flex justify-between items-center hover:bg-slate-50 dark:hover:bg-slate-800/50 cursor-pointer active:scale-[0.98]" 
                                            },
                                                React.createElement("div", { className: "flex items-center gap-4" },
                                                    React.createElement("div", { style: { backgroundColor: `${cat.color}15`, color: cat.color }, className: "w-12 h-12 rounded-2xl flex items-center justify-center" }, React.createElement(IconRenderer, { name: cat.icon })),
                                                    React.createElement("div", null, 
                                                        React.createElement("p", { className: "font-bold text-sm text-slate-700 dark:text-white" }, cat.name), 
                                                        React.createElement("div", { className: "flex items-center gap-2 text-xs text-slate-400 dark:text-slate-500" }, 
                                                            React.createElement("span", null, formatDate(t.date)), 
                                                            t.description && React.createElement("span", { className: "truncate max-w-[80px]" }, "‚Ä¢ ", t.description)
                                                        )
                                                    )
                                                ),
                                                React.createElement("div", { className: "text-right" }, 
                                                    React.createElement("span", { className: `font-bold text-sm block ${t.type === 'income' ? 'text-emerald-500' : 'text-slate-700 dark:text-slate-300'}` }, t.type === 'income' ? '+' : '-', formatCordoba(t.amount))
                                                )
                                            );
                                        })
                                    )
                                )
                            ),
                            
                            activeTab === 'goals' && React.createElement("div", { /* ... (Sin cambios: Metas) ... */ }),
                            
                            activeTab === 'stats' && React.createElement(StatsTab, { data: currentData, categories: categories, darkMode: darkMode }),

                            activeTab === 'profile' && React.createElement("div", { className: "space-y-5 fade-in" },
                                /* ... (Sin cambios: Card de Perfil, Selector de Tema, Selector de G√©nero, Modo Oscuro) ... */
                                React.createElement("div", { className: "bg-white dark:bg-slate-850 rounded-2xl overflow-hidden shadow-sm border border-slate-100 dark:border-slate-800 divide-y divide-slate-100 dark:divide-slate-800" },
                                    /* ... (Opciones de G√©nero y Modo Oscuro) ... */
                                    
                                    // --- NUEVO: Botones de Backup/Restore ---
                                    React.createElement("button", { onClick: handleBackup, className: "w-full p-4 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-800 text-blue-500 transition-colors" }, 
                                        React.createElement("span", { className: "font-medium text-sm flex items-center gap-3" }, React.createElement(Download, { size: 18 }), " Exportar Backup (.json)")
                                    ),
                                    React.createElement("button", { onClick: () => fileInputRef.current && fileInputRef.current.click(), className: "w-full p-4 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-800 text-emerald-500 transition-colors" }, 
                                        React.createElement("span", { className: "font-medium text-sm flex items-center gap-3" }, React.createElement(Upload, { size: 18 }), " Importar Backup (.json)"),
                                        React.createElement("input", { type: "file", ref: fileInputRef, hidden: true, accept: ".json,application/json", onChange: handleRestore })
                                    ),
                                    React.createElement("button", { onClick: () => setShowResetConfirm(true), className: "w-full p-4 flex items-center justify-between hover:bg-rose-50 dark:hover:bg-rose-900/10 text-rose-500 transition-colors" }, 
                                        React.createElement("span", { className: "font-medium text-sm flex items-center gap-3" }, React.createElement(Trash2, { size: 18 }), " Borrar datos de ", currentProfile.name)
                                    ),
                                    React.createElement("button", { onClick: () => setIsAuth(false), className: "w-full p-4 bg-white dark:bg-slate-850 rounded-2xl flex items-center justify-between text-slate-500" }, 
                                        React.createElement("span", { className: "font-medium text-sm flex items-center gap-3" }, React.createElement(LogOut, { size: 18 }), " Cerrar Sesi√≥n")
                                    )
                                )
                            )
                        ),
                        
                        // --- NAV ---
                        React.createElement("nav", { /* ... (Sin cambios) ... */ }),

                        // --- MODAL DE REPORTES ---
                        showReportModal && React.createElement("div", { /* ... (Sin cambios) ... */ }),

                        // --- MODAL DE TRANSACCI√ìN (Ahora para 'Nuevo' y 'Editar') ---
                        showTransModal && React.createElement("div", { className: "fixed inset-0 z-50 bg-black/50 flex items-end sm:items-center justify-center fade-in" },
                            React.createElement("div", { className: "bg-white dark:bg-slate-850 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl border border-transparent dark:border-slate-800" },
                                React.createElement("div", { className: "flex justify-between items-center mb-6" }, 
                                    React.createElement("h3", { className: "font-bold text-lg text-slate-800 dark:text-white" }, editingTx ? "Editar Movimiento" : "Nuevo Movimiento"), 
                                    React.createElement("button", { onClick: () => { setShowTransModal(false); resetTransForm(); }, className: "p-2 bg-slate-100 dark:bg-slate-800 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700" }, React.createElement(X, { size: 20, className: "text-slate-600 dark:text-white" }))
                                ),
                                formError && React.createElement("div", { /* ... (Sin cambios: Error) ... */ }),
                                React.createElement("div", { className: "space-y-5" },
                                    /* ... (Sin cambios: Toggle Ingreso/Gasto, Input Monto, Input Fecha) ... */
                                    React.createElement("button", { onClick: () => setShowCatModal(true), /* ... (Sin cambios: Selector Categor√≠a) ... */ }),
                                    React.createElement("input", { placeholder: "Nota (Opcional)", /* ... (Sin cambios: Input Nota) ... */ }),
                                    
                                    // --- Botones de Guardar / Borrar ---
                                    React.createElement("div", { className: "flex gap-3" },
                                        editingTx && React.createElement("button", { onClick: handleDeleteTrans, className: "p-4 bg-slate-100 dark:bg-slate-800 text-rose-500 rounded-xl" },
                                            React.createElement(Trash2, { size: 24 })
                                        ),
                                        React.createElement("button", { onClick: handleSaveTrans, className: `w-full py-4 rounded-xl text-white font-bold text-lg shadow-md active:scale-95 transition-transform ${transForm.type === 'income' ? 'bg-emerald-500' : 'bg-rose-500'}` }, 
                                            editingTx ? "Actualizar" : "Guardar"
                                        )
                                    )
                                )
                            )
                        ),
                        
                        // --- MODAL ELEGIR CATEGOR√çA (Con bot√≥n 'Gestionar') ---
                        showCatModal && React.createElement("div", { className: "fixed inset-0 z-50 bg-black/50 flex items-end sm:items-center justify-center fade-in" },
                            React.createElement("div", { className: "bg-white dark:bg-slate-850 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 max-h-[80vh] overflow-y-auto shadow-2xl border border-transparent dark:border-slate-800" },
                                React.createElement("div", { className: "flex justify-between items-center mb-6" }, 
                                    React.createElement("h3", { className: "font-bold text-lg text-slate-800 dark:text-white" }, "Elige Categor√≠a"), 
                                    React.createElement("button", { onClick: () => setShowCatModal(false), className: "p-2 bg-slate-100 dark:bg-slate-800 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700" }, React.createElement(X, { size: 20, className: "text-slate-600 dark:text-white" }))
                                ),
                                React.createElement("div", { className: "grid grid-cols-3 gap-3" },
                                    categories.map(c => React.createElement("button", { key: c.id, onClick: () => { setTransForm({ ...transForm, categoryId: c.id }); setShowCatModal(false); }, className: "flex flex-col items-center gap-2 p-3 rounded-2xl border border-slate-100 dark:border-slate-800 hover:bg-indigo-50 dark:hover:bg-slate-800 transition-colors" }, 
                                        React.createElement("div", { style: { color: c.color }, className: "bg-slate-50 dark:bg-slate-800 p-3 rounded-full" }, React.createElement(IconRenderer, { name: c.icon, size: 24 })), 
                                        React.createElement("span", { className: "text-xs font-bold text-slate-600 dark:text-slate-300" }, c.name)
                                    )),
                                    React.createElement("button", { onClick: () => { setShowCatModal(false); setEditingCat(null); setCatForm({ name: '', icon: 'Star', color: '#6366f1' }); setShowCreateCat(true); }, className: "flex flex-col items-center gap-2 p-3 rounded-2xl border border-dashed border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800" }, 
                                        React.createElement("div", { className: "bg-slate-100 dark:bg-slate-800 p-3 rounded-full text-slate-400" }, React.createElement(Plus, { size: 24 })), 
                                        React.createElement("span", { className: "text-xs font-bold text-slate-400" }, "Nueva")
                                    ),
                                    React.createElement("button", { onClick: () => { setShowCatModal(false); setShowManageCat(true); }, className: "flex flex-col items-center gap-2 p-3 rounded-2xl border border-dashed border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800" }, 
                                        React.createElement("div", { className: "bg-slate-100 dark:bg-slate-800 p-3 rounded-full text-slate-400" }, React.createElement(Settings, { size: 24 })), 
                                        React.createElement("span", { className: "text-xs font-bold text-slate-400" }, "Gestionar")
                                    )
                                )
                            )
                        ),
                        
                        // --- MODAL CREAR/EDITAR CATEGOR√çA ---
                        showCreateCat && React.createElement("div", { className: "fixed inset-0 z-50 bg-black/50 flex items-end sm:items-center justify-center fade-in" },
                            React.createElement("div", { className: "bg-white dark:bg-slate-850 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl border border-transparent dark:border-slate-800" },
                                React.createElement("h3", { className: "font-bold text-lg mb-4 text-slate-800 dark:text-white" }, editingCat ? "Editar Categor√≠a" : "Crear Categor√≠a"),
                                React.createElement("div", { className: "space-y-4" },
                                    React.createElement("input", { placeholder: "Nombre", autoFocus: true, className: "w-full p-4 bg-slate-50 dark:bg-black rounded-xl border-none outline-none font-bold text-slate-800 dark:text-white placeholder-slate-400", value: catForm.name, onChange: e => setCatForm({ ...catForm, name: e.target.value }) }),
                                    React.createElement("div", { className: "flex gap-2 overflow-x-auto pb-2 scrollbar-hide" }, Object.keys(ICON_MAP).map(k => React.createElement("button", { key: k, onClick: () => setCatForm({ ...catForm, icon: k }), className: `p-3 rounded-xl shrink-0 transition-colors ${catForm.icon === k ? 'bg-indigo-600 text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-400'}` }, React.createElement(IconRenderer, { name: k })))),
                                    React.createElement("div", { className: "flex gap-3 overflow-x-auto pb-2 scrollbar-hide" }, ['#ef4444', '#f97316', '#f59e0b', '#10b981', '#3b82f6', '#6366f1', '#ec4899'].map(c => React.createElement("button", { key: c, onClick: () => setCatForm({ ...catForm, color: c }), style: { backgroundColor: c }, className: `w-10 h-10 rounded-full shrink-0 transition-transform ${catForm.color === c ? 'scale-110 ring-2 ring-slate-400' : ''}` }))),
                                    React.createElement("div", { className: "flex gap-2 pt-2" },
                                        React.createElement("button", { onClick: () => { setShowCreateCat(false); setEditingCat(null); }, className: "flex-1 py-3 rounded-xl font-bold text-slate-500 bg-slate-100 dark:bg-slate-800" }, "Cancelar"),
                                        React.createElement("button", { onClick: handleSaveCategory, className: "flex-1 py-3 rounded-xl font-bold text-white bg-indigo-500 shadow-md" }, editingCat ? "Actualizar" : "Crear")
                                    )
                                )
                            )
                        ),

                        // --- NUEVO: MODAL GESTIONAR CATEGOR√çAS ---
                        showManageCat && React.createElement("div", { className: "fixed inset-0 z-50 bg-black/50 flex items-end sm:items-center justify-center fade-in" },
                            React.createElement("div", { className: "bg-white dark:bg-slate-850 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 max-h-[80vh] overflow-y-auto shadow-2xl border border-transparent dark:border-slate-800" },
                                React.createElement("div", { className: "flex justify-between items-center mb-6" }, 
                                    React.createElement("h3", { className: "font-bold text-lg text-slate-800 dark:text-white" }, "Gestionar Categor√≠as"), 
                                    React.createElement("button", { onClick: () => setShowManageCat(false), className: "p-2 bg-slate-100 dark:bg-slate-800 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700" }, React.createElement(X, { size: 20, className: "text-slate-600 dark:text-white" }))
                                ),
                                React.createElement("div", { className: "space-y-2" },
                                    categories.map(c => React.createElement("div", { key: c.id, className: "flex items-center justify-between p-3 rounded-2xl border border-slate-100 dark:border-slate-800" },
                                        React.createElement("div", { className: "flex items-center gap-3" },
                                            React.createElement("div", { style: { color: c.color } }, React.createElement(IconRenderer, { name: c.icon, size: 24 })),
                                            React.createElement("span", { className: "font-bold text-slate-700 dark:text-white" }, c.name)
                                        ),
                                        React.createElement("div", { className: "flex gap-2" },
                                            React.createElement("button", { onClick: () => handleStartEditCat(c), className: "p-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-lg" }, React.createElement(Edit3, { size: 16 })),
                                            React.createElement("button", { onClick: () => handleDeleteCategory(c.id), className: "p-2 bg-rose-50 dark:bg-rose-900/20 text-rose-500 rounded-lg" }, React.createElement(Trash2, { size: 16 }))
                                        )
                                    ))
                                )
                            )
                        ),

                        // --- OTROS MODALES (Sin cambios) ---
                        showGoalModal && React.createElement("div", { /* ... */ }),
                        showNameEdit && React.createElement("div", { /* ... */ }),
                        showResetConfirm && React.createElement("div", { /* ... */ }),

                        // --- NUEVO: TOAST NOTIFICATION ---
                        React.createElement(Toast, { message: toast?.message, show: !!toast, onDismiss: () => setToast(null) })
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
