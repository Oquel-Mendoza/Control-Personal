<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control Personal</title>
    
    <!-- CONEXIÓN CON LOS ARCHIVOS DE INSTALACIÓN -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#2563eb">

    <!-- Configuración iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mi Control">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/891/891630.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { slate: { 850: '#1e293b', 900: '#0f172a' } }, fontFamily: { sans: ['system-ui', '-apple-system', 'sans-serif'] } } }
        }
    </script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-tap-highlight-color: transparent; user-select: none; overscroll-behavior-y: none; }
        input { user-select: text; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-950 text-slate-800 h-screen overflow-hidden select-none transition-colors duration-300">
    <div id="root" class="h-full overflow-y-auto scrollbar-hide"></div>

    <!-- Registro del Service Worker para Instalación -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('App lista para instalar', reg))
                    .catch(err => console.log('Error SW', err));
            });
        }
    </script>

    <!-- Lógica de la App -->
    <script type="module">
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Wallet, Plus, X, ChevronRight, Lock, LogOut, 
            LayoutGrid, PieChart as PieIcon, Settings, Trash2, 
            ShoppingBag, Coffee, Car, Home, Zap, Heart, Briefcase, 
            Smartphone, Plane, Gift, Music, Book, Smile, Star, 
            TrendingUp, TrendingDown, Target, Sun, Moon, User, 
            RefreshCcw, UserCircle2, Palette, Check, AlertTriangle,
            Clock, ShieldCheck, Ban
        } from 'https://esm.sh/lucide-react@0.263.1';

        const ICON_MAP = { ShoppingBag, Coffee, Car, Home, Zap, Heart, Briefcase, Smartphone, Plane, Gift, Music, Book, Smile, Star, Target, User, Wallet };
        
        const THEME_COLORS = {
            blue:   { name: 'Azul',   bg: 'bg-blue-600',   text: 'text-blue-600',   ring: 'ring-blue-400' },
            indigo: { name: 'Índigo', bg: 'bg-indigo-500', text: 'text-indigo-500', ring: 'ring-indigo-400' },
            emerald:{ name: 'Verde',  bg: 'bg-emerald-600',text: 'text-emerald-600',ring: 'ring-emerald-400' },
            orange: { name: 'Naranja',bg: 'bg-orange-500', text: 'text-orange-500', ring: 'ring-orange-400' },
            rose:   { name: 'Rosa',   bg: 'bg-rose-500',   text: 'text-rose-500',   ring: 'ring-rose-400' },
            slate:  { name: 'Negro',  bg: 'bg-slate-700',  text: 'text-slate-700',  ring: 'ring-slate-400' },
        };

        const DEFAULT_CATS = [
            { id: 'c1', name: 'Comida', icon: 'Coffee', color: '#F59E0B' },
            { id: 'c2', name: 'Transporte', icon: 'Car', color: '#3B82F6' },
            { id: 'c3', name: 'Casa', icon: 'Home', color: '#10B981' },
            { id: 'c4', name: 'Ocio', icon: 'Smile', color: '#EC4899' },
        ];

        const safeLoad = (key, fallback) => {
            try { const item = localStorage.getItem(key); return item ? JSON.parse(item) : fallback; } catch (e) { return fallback; }
        };
        const formatCordoba = (amount) => new Intl.NumberFormat('es-NI', { style: 'currency', currency: 'NIO', maximumFractionDigits: 0 }).format(amount);
        const formatDate = (isoString) => { 
            if (!isoString) return ''; 
            const date = new Date(isoString); 
            return date.toLocaleDateString('es-NI', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' }); 
        };

        const Card = ({ children, className = "", onClick }) => React.createElement('div', { onClick, className: `bg-white dark:bg-slate-850 p-5 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm ${className}` }, children);
        const IconRenderer = ({ name, size = 20, className }) => { const Icon = ICON_MAP[name] || Star; return React.createElement(Icon, { size, className }); };

        function App() {
            const [config, setConfig] = useState(() => safeLoad('ew_ctrl_config', null));
            const [darkMode, setDarkMode] = useState(() => safeLoad('ew_dark_mode', true));
            const [isAuth, setIsAuth] = useState(false);
            const [pinInput, setPinInput] = useState('');
            const [errorMsg, setErrorMsg] = useState('');

            const [newUserName, setNewUserName] = useState('');
            const [newUserPin, setNewUserPin] = useState('');
            const [newUserPinConfirm, setNewUserPinConfirm] = useState('');

            const [transactions, setTransactions] = useState(() => safeLoad('ew_ctrl_trans', []));
            const [categories, setCategories] = useState(() => safeLoad('ew_ctrl_cats', DEFAULT_CATS));
            const [goals, setGoals] = useState(() => safeLoad('ew_ctrl_goals', []));

            const [walletMode, setWalletMode] = useState('personal');
            const [activeTab, setActiveTab] = useState('home');
            const [showTransModal, setShowTransModal] = useState(false);
            const [showCatModal, setShowCatModal] = useState(false);
            const [showCreateCat, setShowCreateCat] = useState(false);
            const [showGoalModal, setShowGoalModal] = useState(false);
            const [showNameEdit, setShowNameEdit] = useState(false);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [formError, setFormError] = useState('');
            const [tempName, setTempName] = useState('');

            const getNowInput = () => { const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); return now.toISOString().slice(0, 16); };
            const [transForm, setTransForm] = useState({ amount: '', desc: '', type: 'expense', categoryId: null, date: getNowInput() });
            const [catForm, setCatForm] = useState({ name: '', icon: 'Star', color: '#6366f1' });
            const [goalForm, setGoalForm] = useState({ name: '', target: '' });

            useEffect(() => localStorage.setItem('ew_ctrl_trans', JSON.stringify(transactions)), [transactions]);
            useEffect(() => localStorage.setItem('ew_ctrl_cats', JSON.stringify(categories)), [categories]);
            useEffect(() => localStorage.setItem('ew_ctrl_goals', JSON.stringify(goals)), [goals]);
            useEffect(() => { if (config) localStorage.setItem('ew_ctrl_config', JSON.stringify(config)); }, [config]);
            useEffect(() => { localStorage.setItem('ew_dark_mode', JSON.stringify(darkMode)); }, [darkMode]);

            useEffect(() => {
                if (config) {
                    let fixed = false;
                    const newConfig = { ...config };
                    if (!newConfig.personal) { newConfig.personal = { name: 'Mío', theme: 'blue', gender: 'male' }; fixed = true; }
                    if (!newConfig.partner) { newConfig.partner = { name: 'Pareja', theme: 'rose', gender: 'female' }; fixed = true; }
                    if (fixed) setConfig(newConfig);
                }
            }, [config]);

            const safeConfig = config || { personal: { name: 'Usuario' }, partner: { name: 'Pareja' } };
            const currentProfile = safeConfig[walletMode] || (walletMode === 'personal' ? { name: 'Mío', theme: 'blue' } : { name: 'Pareja', theme: 'rose' });
            const theme = THEME_COLORS[currentProfile.theme] || THEME_COLORS.blue;

            const updateProfile = (updates) => { if (!config) return; setConfig(prev => ({ ...prev, [walletMode]: { ...prev[walletMode], ...updates } })); };
            
            const currentData = transactions.filter(t => t.walletMode === walletMode);
            const currentGoals = goals.filter(g => g.walletMode === walletMode);
            const income = currentData.filter(t => t.type === 'income').reduce((acc, t) => acc + (Number(t.amount) || 0), 0);
            const expense = currentData.filter(t => t.type === 'expense').reduce((acc, t) => acc + (Number(t.amount) || 0), 0);
            const balance = income - expense;
            const sortedData = [...currentData].sort((a, b) => new Date(b.date) - new Date(a.date));

            const handleFinishSetup = () => {
                if (!newUserName.trim() || newUserPin.length < 4) return;
                if (newUserPin !== newUserPinConfirm) { setErrorMsg('PINs no coinciden'); return; }
                const newConfig = { pin: newUserPin, personal: { name: newUserName, theme: 'blue', gender: 'male' }, partner: { name: 'Pareja', theme: 'rose', gender: 'female' } };
                setConfig(newConfig);
                localStorage.setItem('ew_ctrl_config', JSON.stringify(newConfig));
                setIsAuth(true);
            };

            const handleLogin = (e) => { e.preventDefault(); if (pinInput === config.pin) { setIsAuth(true); setErrorMsg(''); } else setErrorMsg('PIN Incorrecto'); };

            const handleAddTrans = () => {
                setFormError('');
                const amount = Number(transForm.amount);
                if (!amount || amount <= 0) { setFormError('Monto inválido'); return; }
                if (!transForm.categoryId) { setFormError('Elige categoría'); return; }
                
                if (transForm.type === 'expense' && amount > balance) { setFormError('Fondos insuficientes'); return; }

                const newTx = { 
                    id: Date.now(), 
                    walletMode, 
                    amount, 
                    description: transForm.desc || '', 
                    type: transForm.type, 
                    categoryId: transForm.categoryId, 
                    date: transForm.date || new Date().toISOString() 
                };
                setTransactions([newTx, ...transactions]);
                setShowTransModal(false);
                setTransForm({ amount: '', desc: '', type: 'expense', categoryId: null, date: getNowInput() });
            };

            const handleResetProfileData = () => {
                const otherTrans = transactions.filter(t => t.walletMode !== walletMode);
                const otherGoals = goals.filter(g => g.walletMode !== walletMode);
                setTransactions(otherTrans);
                setGoals(otherGoals);
                updateProfile({ theme: walletMode === 'personal' ? 'blue' : 'rose', gender: walletMode === 'personal' ? 'male' : 'female' });
                setShowResetConfirm(false);
            };

            return React.createElement("div", { className: darkMode ? "dark" : "" },
                React.createElement("div", { className: "min-h-screen bg-gradient-to-b from-slate-100 to-slate-200 dark:from-slate-900 dark:to-black text-slate-800 dark:text-slate-200 font-sans pb-24 transition-colors duration-300" },

                    /* PANTALLA 1: SETUP */
                    !config && React.createElement("div", { className: "min-h-screen flex items-center justify-center p-6 fade-in relative" },
                        React.createElement("button", { onClick: () => setDarkMode(!darkMode), className: "absolute top-6 right-6 p-3 rounded-full bg-white dark:bg-slate-800 shadow-lg border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-200 z-50 active:scale-90 transition-transform" }, darkMode ? React.createElement(Sun, { size: 24 }) : React.createElement(Moon, { size: 24 })),
                        React.createElement("div", { className: "w-full max-w-sm bg-white dark:bg-slate-800/90 backdrop-blur-md rounded-[2rem] p-8 shadow-2xl border border-white/50 dark:border-slate-700" },
                            React.createElement("div", { className: "flex justify-center mb-6" }, React.createElement("div", { className: "bg-blue-600 p-4 rounded-2xl shadow-blue-500/30 shadow-lg" }, React.createElement(ShieldCheck, { className: "text-white", size: 40 }))),
                            React.createElement("h2", { className: "text-2xl font-bold text-center mb-2 text-slate-900 dark:text-white" }, "Crear Cuenta"),
                            React.createElement("p", { className: "text-slate-500 dark:text-slate-400 text-center text-sm mb-8" }, "Configura tu acceso seguro."),
                            React.createElement("div", { className: "space-y-5" },
                                React.createElement("input", { className: "w-full p-4 bg-slate-50 dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 rounded-xl font-bold outline-none focus:border-blue-500 dark:focus:border-blue-500 text-slate-900 dark:text-white transition-colors", placeholder: "Tu Nombre", value: newUserName, onChange: e => setNewUserName(e.target.value) }),
                                React.createElement("input", { type: "password", maxLength: 4, inputMode: "numeric", className: "w-full p-4 bg-slate-50 dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 rounded-xl font-bold outline-none focus:border-blue-500 dark:focus:border-blue-500 text-slate-900 dark:text-white tracking-widest text-center transition-colors", placeholder: "PIN (4 dígitos)", value: newUserPin, onChange: e => setNewUserPin(e.target.value) }),
                                React.createElement("input", { type: "password", maxLength: 4, inputMode: "numeric", className: "w-full p-4 bg-slate-50 dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 rounded-xl font-bold outline-none focus:border-blue-500 dark:focus:border-blue-500 text-slate-900 dark:text-white tracking-widest text-center transition-colors", placeholder: "Confirmar PIN", value: newUserPinConfirm, onChange: e => { setNewUserPinConfirm(e.target.value); setErrorMsg(''); } }),
                                errorMsg && React.createElement("p", { className: "text-rose-500 text-xs text-center font-bold bg-rose-50 dark:bg-rose-900/20 p-2 rounded-lg" }, errorMsg),
                                React.createElement("button", { onClick: handleFinishSetup, disabled: !newUserName || newUserPin.length < 4 || newUserPin !== newUserPinConfirm, className: "w-full bg-blue-600 disabled:bg-slate-300 dark:disabled:bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/20 mt-4 active:scale-95 transition-all" }, "Guardar y Entrar")
                            )
                        )
                    ),

                    /* PANTALLA 2: LOGIN (MEJORADO) */
                    config && !isAuth && React.createElement("div", { className: "min-h-screen flex items-center justify-center p-6 fade-in relative" },
                        // Botón Modo Oscuro Flotante y Visible
                        React.createElement("button", { onClick: () => setDarkMode(!darkMode), className: "absolute top-6 right-6 p-3 rounded-full bg-white dark:bg-slate-800 shadow-lg border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-200 z-50 active:scale-90 transition-transform" }, darkMode ? React.createElement(Sun, { size: 24 }) : React.createElement(Moon, { size: 24 })),
                        
                        React.createElement("div", { className: "w-full max-w-sm bg-white dark:bg-slate-800/95 backdrop-blur-md rounded-[2rem] p-8 shadow-2xl border border-white/50 dark:border-slate-700" },
                            React.createElement("div", { className: "flex justify-center mb-6" }, React.createElement("div", { className: "bg-slate-100 dark:bg-slate-700 p-4 rounded-2xl shadow-inner" }, React.createElement(Lock, { className: "text-slate-600 dark:text-slate-300", size: 32 }))),
                            React.createElement("h2", { className: "text-2xl font-bold text-center text-slate-800 dark:text-white mb-1" }, "Hola, ", safeConfig.personal?.name || 'Usuario'),
                            React.createElement("form", { onSubmit: handleLogin, className: "space-y-6 mt-8" },
                                React.createElement("input", { 
                                    type: "password", 
                                    maxLength: 4, 
                                    inputMode: "numeric", 
                                    className: "w-full bg-slate-50 dark:bg-slate-950 border-2 border-slate-200 dark:border-slate-700 rounded-2xl py-5 text-center text-3xl font-bold tracking-[1em] text-slate-800 dark:text-white focus:border-blue-500 dark:focus:border-blue-500 outline-none transition-colors shadow-sm", 
                                    placeholder: "••••", 
                                    value: pinInput, 
                                    onChange: (e) => setPinInput(e.target.value) 
                                }),
                                errorMsg && React.createElement("p", { className: "text-rose-500 text-xs text-center font-bold bg-rose-50 dark:bg-rose-900/20 p-2 rounded-lg" }, errorMsg),
                                React.createElement("button", { className: "w-full bg-slate-900 dark:bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-transform" }, "Entrar")
                            ),
                            React.createElement("div", { className: "mt-8 pt-6 border-t border-slate-100 dark:border-slate-700 flex justify-center" },
                                React.createElement("button", { onClick: () => { if (confirm("¿Resetear de fábrica? Se borrará todo.")) { localStorage.clear(); window.location.reload(); } }, className: "text-xs text-slate-400 hover:text-rose-500 flex items-center gap-1 transition-colors" }, React.createElement(RefreshCcw, { size: 12 }), " Resetear App")
                            )
                        )
                    ),

                    /* PANTALLA 3: APP INTERNA */
                    config && isAuth && React.createElement(React.Fragment, null,
                        // Header
                        React.createElement("header", { className: `${theme.bg} pt-8 pb-20 px-6 rounded-b-[2.5rem] shadow-lg relative overflow-hidden transition-colors duration-500` },
                            React.createElement("div", { className: "relative z-10 flex justify-center mb-6" },
                                React.createElement("div", { className: "bg-black/20 p-1 rounded-full flex backdrop-blur-sm" },
                                    React.createElement("button", { onClick: () => setWalletMode('personal'), className: `px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 transition-all ${walletMode === 'personal' ? 'bg-white text-slate-800 shadow-sm' : 'text-white/70'}` }, React.createElement(User, { size: 14 }), safeConfig.personal?.name || 'Mío'),
                                    React.createElement("button", { onClick: () => setWalletMode('partner'), className: `px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 transition-all ${walletMode === 'partner' ? 'bg-white text-slate-800 shadow-sm' : 'text-white/70'}` }, React.createElement(Heart,
