import React, { useState, useEffect, useMemo } from 'react';
import { 
  Wallet, Plus, X, ChevronRight, Lock, LogOut, 
  LayoutGrid, PieChart as PieIcon, Settings, Trash2, 
  ShoppingBag, Coffee, Car, Home, Zap, Heart, Briefcase, 
  Smartphone, Plane, Gift, Music, Book, Smile, Star, 
  TrendingUp, TrendingDown, Target, Sun, Moon, User, 
  RefreshCcw, UserCircle2, Palette, Check, AlertTriangle,
  Clock, ShieldCheck, Ban
} from 'lucide-react';

// --- 1. CONFIGURACIÓN ---

const ICON_MAP = {
  ShoppingBag, Coffee, Car, Home, Zap, Heart, Briefcase, 
  Smartphone, Plane, Gift, Music, Book, Smile, Star, 
  Target, User, Wallet
};

// TEMA SUAVE (Pasteles / Mate)
const THEME_COLORS = {
  indigo: { name: 'Índigo', bg: 'bg-indigo-500', text: 'text-indigo-500', ring: 'ring-indigo-400' },
  blue:   { name: 'Azul',   bg: 'bg-blue-500',   text: 'text-blue-500',   ring: 'ring-blue-400' },
  emerald:{ name: 'Verde',  bg: 'bg-emerald-500',text: 'text-emerald-500',ring: 'ring-emerald-400' },
  violet: { name: 'Violeta',bg: 'bg-violet-500', text: 'text-violet-500', ring: 'ring-violet-400' },
  orange: { name: 'Naranja',bg: 'bg-orange-500', text: 'text-orange-500', ring: 'ring-orange-400' },
  rose:   { name: 'Rosa',   bg: 'bg-rose-500',   text: 'text-rose-500',   ring: 'ring-rose-400' },
  slate:  { name: 'Gris',   bg: 'bg-slate-500',  text: 'text-slate-500',  ring: 'ring-slate-400' },
};

const DEFAULT_CATS = [
  { id: 'c1', name: 'Comida', icon: 'Coffee', color: '#F59E0B' },
  { id: 'c2', name: 'Transporte', icon: 'Car', color: '#3B82F6' },
  { id: 'c3', name: 'Casa', icon: 'Home', color: '#10B981' },
  { id: 'c4', name: 'Ocio', icon: 'Smile', color: '#EC4899' },
];

const safeLoad = (key, fallback) => {
  try {
    const item = localStorage.getItem(key);
    return item ? JSON.parse(item) : fallback;
  } catch (e) { return fallback; }
};

const formatCordoba = (amount) => {
  return new Intl.NumberFormat('es-NI', { style: 'currency', currency: 'NIO', maximumFractionDigits: 0 }).format(amount);
};

const formatDate = (isoString) => {
  if (!isoString) return '';
  const date = new Date(isoString);
  return date.toLocaleDateString('es-NI', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' });
};

const Card = ({ children, className = "", onClick }) => (
  <div onClick={onClick} className={`bg-white dark:bg-zinc-900 p-5 rounded-2xl border border-slate-200 dark:border-zinc-800 transition-colors duration-200 ${className}`}>
    {children}
  </div>
);

const IconRenderer = ({ name, size = 20, className }) => {
  const Icon = ICON_MAP[name] || Star;
  return <Icon size={size} className={className} />;
};

// --- APP PRINCIPAL ---

export default function App() {
  const [config, setConfig] = useState(() => safeLoad('ew_ctrl_config', null));
  const [darkMode, setDarkMode] = useState(() => safeLoad('ew_dark_mode', true)); 
  const [isAuth, setIsAuth] = useState(false);
  const [pinInput, setPinInput] = useState('');
  const [errorMsg, setErrorMsg] = useState('');
  const [newUserName, setNewUserName] = useState('');
  const [newUserPin, setNewUserPin] = useState('');
  const [newUserPinConfirm, setNewUserPinConfirm] = useState('');

  const [transactions, setTransactions] = useState(() => safeLoad('ew_ctrl_trans', []));
  const [categories, setCategories] = useState(() => safeLoad('ew_ctrl_cats', DEFAULT_CATS));
  const [goals, setGoals] = useState(() => safeLoad('ew_ctrl_goals', []));

  const [walletMode, setWalletMode] = useState('personal'); 
  const [activeTab, setActiveTab] = useState('home');
  
  const [showTransModal, setShowTransModal] = useState(false);
  const [showCatModal, setShowCatModal] = useState(false);
  const [showCreateCat, setShowCreateCat] = useState(false);
  const [showGoalModal, setShowGoalModal] = useState(false);
  const [showNameEdit, setShowNameEdit] = useState(false);
  const [showResetConfirm, setShowResetConfirm] = useState(false);
  const [formError, setFormError] = useState('');

  const getNowInput = () => {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    return now.toISOString().slice(0,16);
  };
  const [transForm, setTransForm] = useState({ amount: '', desc: '', type: 'expense', categoryId: null, date: getNowInput() });
  const [catForm, setCatForm] = useState({ name: '', icon: 'Star', color: '#6366f1' });
  const [goalForm, setGoalForm] = useState({ name: '', target: '' });
  const [tempName, setTempName] = useState('');

  useEffect(() => localStorage.setItem('ew_ctrl_trans', JSON.stringify(transactions)), [transactions]);
  useEffect(() => localStorage.setItem('ew_ctrl_cats', JSON.stringify(categories)), [categories]);
  useEffect(() => localStorage.setItem('ew_ctrl_goals', JSON.stringify(goals)), [goals]);
  useEffect(() => { if (config) localStorage.setItem('ew_ctrl_config', JSON.stringify(config)); }, [config]);
  useEffect(() => { localStorage.setItem('ew_dark_mode', JSON.stringify(darkMode)); }, [darkMode]);

  // --- GENERADOR DE APP (Icono y Nombre) ---
  useEffect(() => {
    document.title = "Control Personal";
    
    // Icono Azul Elegante (SVG inline)
    const svgIcon = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
        <rect width="512" height="512" rx="120" fill="#3B82F6"/>
        <path d="M128 176v160c0 17.7 14.3 32 32 32h192c17.7 0 32-14.3 32-32V176c0-17.7-14.3-32-32-32H160c-17.7 0-32 14.3-32 32zm32-10h192c5.5 0 10 4.5 10 10v160c0 5.5-4.5 10-10 10H160c-5.5 0-10-4.5-10-10V176c0-5.5 4.5-10 10-10z" fill="white"/>
        <path d="M320 256h32v32h-32z" fill="white"/>
        <path d="M140 140h232" stroke="white" stroke-width="30" stroke-linecap="round"/>
      </svg>
    `;
    const iconUrl = `data:image/svg+xml;base64,${btoa(svgIcon)}`;

    // Inyectar Meta Tags
    const updateTag = (selector, attr, value, tagName='link') => {
        let el = document.querySelector(selector);
        if (!el) {
            el = document.createElement(tagName);
            if(tagName === 'link') {
                el.rel = selector.replace("link[rel='", "").replace("']", "");
            } else {
                el.name = selector.replace("meta[name='", "").replace("']", "");
            }
            document.head.appendChild(el);
        }
        el.setAttribute(attr, value);
        if(tagName==='link') el.type = 'image/svg+xml';
    };

    updateTag("link[rel='icon']", 'href', iconUrl);
    updateTag("link[rel='apple-touch-icon']", 'href', iconUrl);
    updateTag("meta[name='apple-mobile-web-app-title']", 'content', 'Control Personal', 'meta');
    updateTag("meta[name='apple-mobile-web-app-capable']", 'content', 'yes', 'meta');

  }, []);

  const safeConfig = config || { personal: {}, partner: {} };
  const currentProfile = safeConfig[walletMode] || { name: 'Usuario', theme: 'blue', gender: 'male' };
  const theme = THEME_COLORS[currentProfile.theme] || THEME_COLORS.blue;

  const updateProfile = (updates) => {
    if (!config) return;
    setConfig(prev => ({ ...prev, [walletMode]: { ...prev[walletMode], ...updates } }));
  };

  const handleResetProfileData = () => {
    const otherTrans = transactions.filter(t => t.walletMode !== walletMode);
    const otherGoals = goals.filter(g => g.walletMode !== walletMode);
    setTransactions(otherTrans);
    setGoals(otherGoals);
    updateProfile({ theme: walletMode === 'personal' ? 'blue' : 'rose', gender: walletMode === 'personal' ? 'male' : 'female' });
    setShowResetConfirm(false);
  };

  const handleFinishSetup = () => {
    if (!newUserName.trim() || newUserPin.length < 4) return;
    if (newUserPin !== newUserPinConfirm) { setErrorMsg('PINs no coinciden'); return; }
    const newConfig = {
      pin: newUserPin,
      personal: { name: newUserName, theme: 'blue', gender: 'male' },
      partner: { name: 'Pareja', theme: 'rose', gender: 'female' }
    };
    setConfig(newConfig);
    localStorage.setItem('ew_ctrl_config', JSON.stringify(newConfig));
    setIsAuth(true); 
  };

  const handleLogin = (e) => {
    e.preventDefault();
    if (pinInput === config.pin) { setIsAuth(true); setErrorMsg(''); } 
    else setErrorMsg('PIN Incorrecto');
  };

  const safeTransactions = Array.isArray(transactions) ? transactions : [];
  const currentData = safeTransactions.filter(t => t.walletMode === walletMode);
  const currentGoals = Array.isArray(goals) ? goals.filter(g => g.walletMode === walletMode) : [];

  const income = currentData.filter(t => t.type === 'income').reduce((acc, t) => acc + (Number(t.amount) || 0), 0);
  const expense = currentData.filter(t => t.type === 'expense').reduce((acc, t) => acc + (Number(t.amount) || 0), 0);
  const balance = income - expense;
  const sortedData = [...currentData].sort((a, b) => new Date(b.date) - new Date(a.date));

  const chartData = useMemo(() => {
    const data = currentData.filter(t => t.type === 'expense')
      .reduce((acc, t) => {
        const cat = categories.find(c => c.id === t.categoryId) || { name: 'Otros', color: '#94a3b8' };
        const found = acc.find(i => i.name === cat.name);
        if (found) found.value += Number(t.amount);
        else acc.push({ name: cat.name, value: Number(t.amount), color: cat.color });
        return acc;
      }, []).sort((a, b) => b.value - a.value);
    
    const total = data.reduce((acc, curr) => acc + curr.value, 0);
    let currentDeg = 0;
    const gradientParts = data.map(d => {
      const deg = total === 0 ? 0 : (d.value / total) * 360;
      const str = `${d.color} ${currentDeg}deg ${currentDeg + deg}deg`;
      currentDeg += deg;
      return str;
    });
    return { data, gradient: gradientParts.join(', ') || '#3f3f46 0deg 360deg', total };
  }, [currentData, categories]);

  const handleAddTrans = () => {
    setFormError('');
    const amount = Number(transForm.amount);
    if (!amount || amount <= 0) { setFormError('Monto inválido'); return; }
    if (!transForm.categoryId) { setFormError('Elige categoría'); return; }
    if (transForm.type === 'expense') {
      if (amount > balance) { setFormError('Fondos insuficientes'); return; }
    }
    const newTx = {
      id: Date.now(), walletMode, 
      amount: amount, description: transForm.desc || '', 
      type: transForm.type, categoryId: transForm.categoryId, 
      date: transForm.date || new Date().toISOString()
    };
    setTransactions([newTx, ...transactions]);
    setShowTransModal(false);
    setTransForm({ amount: '', desc: '', type: 'expense', categoryId: null, date: getNowInput() });
  };

  const handleAddGoal = () => {
    setFormError('');
    const target = Number(goalForm.target);
    if(!goalForm.name || !target || target <= 0) { return; }
    setGoals([...goals, { 
      id: Date.now(), walletMode, name: goalForm.name, target: target, current: 0, 
      color: categories[Math.floor(Math.random()*categories.length)].color 
    }]);
    setShowGoalModal(false);
    setGoalForm({ name: '', target: '' });
  };

  const handleUpdateName = () => {
    if(tempName.trim()) { updateProfile({ name: tempName }); setShowNameEdit(false); }
  };

  return (
    <div className={darkMode ? "dark" : ""}>
      <div className="min-h-screen bg-slate-50 dark:bg-black text-slate-800 dark:text-slate-200 transition-colors duration-300 font-sans overflow-x-hidden pb-10">

        {!config && (
          <div className="min-h-screen flex items-center justify-center p-6">
            <button onClick={() => setDarkMode(!darkMode)} className="absolute top-6 right-6 p-3 rounded-full bg-white dark:bg-zinc-900 shadow-sm border border-slate-100 dark:border-zinc-800">{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
            <div className="w-full max-w-sm bg-white dark:bg-zinc-900 rounded-3xl p-8 shadow-lg border border-slate-100 dark:border-zinc-800">
              <div className="flex justify-center mb-6"><div className="bg-blue-500 p-4 rounded-2xl shadow-md"><ShieldCheck className="text-white" size={40} /></div></div>
              <h2 className="text-2xl font-bold text-center mb-2 text-slate-900 dark:text-white">Crear Cuenta</h2>
              <p className="text-slate-400 text-center text-sm mb-8">Configura tu acceso personal.</p>
              <div className="space-y-4">
                <div><label className="text-xs font-bold uppercase text-slate-400 ml-1">Tu Nombre</label><input className="w-full mt-1 p-4 bg-slate-50 dark:bg-zinc-800 rounded-xl font-bold outline-none focus:ring-2 focus:ring-blue-400 text-slate-900 dark:text-white" placeholder="Ej. Juan" value={newUserName} onChange={e => setNewUserName(e.target.value)} /></div>
                <div><label className="text-xs font-bold uppercase text-slate-400 ml-1">PIN (4 dígitos)</label><input type="password" maxLength={4} inputMode="numeric" className="w-full mt-1 p-4 bg-slate-50 dark:bg-zinc-800 rounded-xl font-bold outline-none focus:ring-2 focus:ring-blue-400 text-slate-900 dark:text-white tracking-widest text-center" placeholder="••••" value={newUserPin} onChange={e => setNewUserPin(e.target.value)} /></div>
                <div><label className="text-xs font-bold uppercase text-slate-400 ml-1">Confirma el PIN</label><input type="password" maxLength={4} inputMode="numeric" className="w-full mt-1 p-4 bg-slate-50 dark:bg-zinc-800 rounded-xl font-bold outline-none focus:ring-2 focus:ring-blue-400 text-slate-900 dark:text-white tracking-widest text-center" placeholder="••••" value={newUserPinConfirm} onChange={e => { setNewUserPinConfirm(e.target.value); setErrorMsg(''); }} /></div>
                {errorMsg && <p className="text-rose-500 text-xs text-center font-bold">{errorMsg}</p>}
                <button onClick={handleFinishSetup} disabled={!newUserName || newUserPin.length < 4 || newUserPin !== newUserPinConfirm} className="w-full bg-blue-500 disabled:bg-slate-300 dark:disabled:bg-zinc-800 text-white font-bold py-4 rounded-xl shadow-md mt-4 transition-all">Empezar</button>
              </div>
            </div>
          </div>
        )}

        {config && !isAuth && (
          <div className="min-h-screen flex items-center justify-center p-6">
            <button onClick={() => setDarkMode(!darkMode)} className="absolute top-6 right-6 p-3 rounded-full bg-white/10 backdrop-blur-sm text-white hover:bg-white/20 transition-colors">{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
            <div className="absolute inset-0 bg-slate-900 z-[-1]" />
            <div className="w-full max-w-sm bg-white dark:bg-zinc-950 rounded-3xl p-8 shadow-xl border border-transparent dark:border-zinc-800">
              <div className="flex justify-center mb-6"><div className="bg-zinc-800 p-4 rounded-2xl shadow-md"><Lock className="text-white" size={32} /></div></div>
              <h2 className="text-2xl font-bold text-center text-slate-800 dark:text-white mb-1">Hola, {safeConfig.personal?.name || 'Usuario'}</h2>
              <p className="text-slate-400 text-center text-sm mb-8">Control Personal</p>
              <form onSubmit={handleLogin} className="space-y-6">
                <input type="password" maxLength={4} inputMode="numeric" className="w-full bg-slate-100 dark:bg-zinc-900 border-none rounded-2xl py-4 text-center text-3xl font-bold tracking-[1em] text-slate-800 dark:text-white focus:ring-2 focus:ring-slate-300 dark:focus:ring-zinc-700 outline-none" placeholder="••••" value={pinInput} onChange={(e) => setPinInput(e.target.value)} />
                {errorMsg && <p className="text-rose-500 text-xs text-center font-bold">{errorMsg}</p>}
                <button className="w-full bg-slate-800 dark:bg-blue-600 text-white font-bold py-4 rounded-xl shadow-md hover:scale-[1.02] transition-all">Entrar</button>
              </form>
              <div className="mt-8 pt-6 border-t border-slate-100 dark:border-zinc-900 flex justify-center">
                 <button onClick={() => { if(confirm("¿Borrar todos los datos y empezar de cero?")) { localStorage.clear(); window.location.reload(); }}} className="text-xs text-rose-400 flex items-center gap-1 hover:underline"><RefreshCcw size={12}/> Resetear</button>
              </div>
            </div>
          </div>
        )}

        {config && isAuth && (
          <>
            <header className={`${theme.bg} pt-8 pb-20 px-6 rounded-b-[2.5rem] shadow-lg relative overflow-hidden transition-colors duration-500`}>
              <div className="absolute inset-0 opacity-10 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-white/20 to-transparent"></div>
              
              <div className="relative z-10 flex justify-center mb-6">
                <div className="bg-black/20 p-1 rounded-full flex backdrop-blur-sm max-w-full overflow-hidden">
                  <button onClick={() => setWalletMode('personal')} className={`px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 transition-all truncate max-w-[150px] ${walletMode === 'personal' ? 'bg-white text-slate-800 shadow-sm' : 'text-white/70 hover:text-white'}`}><User size={14} className="shrink-0" /> <span className="truncate">{safeConfig.personal?.name || 'Mío'}</span></button>
                  <button onClick={() => setWalletMode('partner')} className={`px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 transition-all truncate max-w-[150px] ${walletMode === 'partner' ? 'bg-white text-slate-800 shadow-sm' : 'text-white/70 hover:text-white'}`}><Heart size={14} className="shrink-0" /> <span className="truncate">{safeConfig.partner?.name || 'Pareja'}</span></button>
                </div>
              </div>
              <div className="relative z-10 text-center text-white">
                <span className="text-white/80 text-xs font-medium uppercase tracking-wider">Disponible</span>
                <h1 className="text-5xl font-bold tracking-tight mt-1 mb-6">{formatCordoba(balance)}</h1>
                <div className="flex justify-center gap-3">
                  <div className="bg-white/10 backdrop-blur-sm px-4 py-2 rounded-xl flex items-center gap-2 border border-white/5"><div className="bg-emerald-400/20 p-1 rounded-full"><TrendingUp size={14} className="text-emerald-200"/></div><span className="font-bold text-sm">+{formatCordoba(income)}</span></div>
                  <div className="bg-white/10 backdrop-blur-sm px-4 py-2 rounded-xl flex items-center gap-2 border border-white/5"><div className="bg-rose-400/20 p-1 rounded-full"><TrendingDown size={14} className="text-rose-200"/></div><span className="font-bold text-sm">-{formatCordoba(expense)}</span></div>
                </div>
              </div>
            </header>

            <main className="px-5 -mt-10 relative z-20 space-y-6 pb-24">
              {activeTab === 'home' && (
                <>
                  <div className="grid grid-cols-2 gap-4">
                    <button onClick={() => { setTransForm({...transForm, type: 'income'}); setShowTransModal(true); setFormError(''); }} className="bg-white dark:bg-zinc-900 p-4 rounded-2xl shadow-sm flex items-center gap-3 active:scale-95 transition-transform border border-slate-100 dark:border-zinc-800">
                      <div className="bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 p-3 rounded-full"><TrendingUp size={20}/></div>
                      <div className="text-left"><span className="block font-bold text-sm text-slate-700 dark:text-white">Ingreso</span><span className="text-[10px] text-slate-400">Recibir</span></div>
                    </button>
                    <button onClick={() => { setTransForm({...transForm, type: 'expense'}); setShowTransModal(true); setFormError(''); }} className="bg-white dark:bg-zinc-900 p-4 rounded-2xl shadow-sm flex items-center gap-3 active:scale-95 transition-transform border border-slate-100 dark:border-zinc-800">
                      <div className="bg-rose-50 dark:bg-rose-900/20 text-rose-500 dark:text-rose-400 p-3 rounded-full"><TrendingDown size={20}/></div>
                      <div className="text-left"><span className="block font-bold text-sm text-slate-700 dark:text-white">Gasto</span><span className="text-[10px] text-slate-400">Pagar</span></div>
                    </button>
                  </div>
                  <div>
                    <h3 className="font-bold text-slate-500 dark:text-slate-500 text-xs uppercase tracking-wider mb-3 ml-1">Historial</h3>
                    <div className="space-y-3">
                      {sortedData.length === 0 ? (
                        <div className="text-center py-12 bg-white dark:bg-zinc-900 rounded-2xl border-2 border-dashed border-slate-200 dark:border-zinc-800 opacity-60 flex flex-col items-center">
                          <Wallet size={40} className="text-slate-300 dark:text-slate-600 mb-2"/><p className="text-slate-400 dark:text-slate-500 text-sm">Sin movimientos</p>
                        </div>
                      ) : (
                        sortedData.slice(0, 15).map(t => {
                          const cat = categories.find(c => c.id === t.categoryId) || DEFAULT_CATS[0];
                          return (
                            <Card key={t.id} className="!p-3 flex justify-between items-center hover:bg-slate-50 dark:hover:bg-zinc-800/50">
                              <div className="flex items-center gap-4">
                                <div style={{ backgroundColor: `${cat.color}15`, color: cat.color }} className="w-12 h-12 rounded-2xl flex items-center justify-center"><IconRenderer name={cat.icon} /></div>
                                <div>
                                  <p className="font-bold text-sm text-slate-700 dark:text-white">{cat.name}</p>
                                  <div className="flex items-center gap-2 text-xs text-slate-400 dark:text-slate-500"><span>{formatDate(t.date)}</span>{t.description && <span className="truncate max-w-[80px]">• {t.description}</span>}</div>
                                </div>
                              </div>
                              <div className="text-right"><span className={`font-bold text-sm block ${t.type === 'income' ? 'text-emerald-500' : 'text-slate-700 dark:text-slate-300'}`}>{t.type === 'income' ? '+' : '-'}{formatCordoba(t.amount)}</span></div>
                            </Card>
                          );
                        })
                      )}
                    </div>
                  </div>
                </>
              )}

              {activeTab === 'stats' && (
                <div>
                  <Card className="flex flex-col items-center pt-8 pb-8">
                    <h3 className="font-bold text-slate-800 dark:text-white mb-6">Gastos</h3>
                    <div className="relative w-52 h-52 rounded-full mb-8 bg-slate-50 dark:bg-zinc-800" style={{ background: chartData.total > 0 ? `conic-gradient(${chartData.gradient})` : '' }}>
                      <div className="absolute inset-4 bg-white dark:bg-zinc-900 rounded-full flex items-center justify-center flex-col z-10 shadow-sm">
                        <span className="text-xs text-slate-400 font-medium">Total</span>
                        <span className="text-xl font-bold text-slate-800 dark:text-white">{formatCordoba(expense)}</span>
                      </div>
                    </div>
                    <div className="w-full space-y-2">
                      {chartData.data.map((d, i) => (
                        <div key={i} className="flex items-center justify-between text-sm p-2 hover:bg-slate-50 dark:hover:bg-zinc-800 rounded-lg transition-colors">
                          <div className="flex items-center gap-3"><div className="w-3 h-3 rounded-full" style={{ backgroundColor: d.color }} /><span className="text-slate-600 dark:text-slate-300">{d.name}</span></div>
                          <span className="font-bold text-slate-700 dark:text-white">{formatCordoba(d.value)}</span>
                        </div>
                      ))}
                      {chartData.data.length === 0 && <p className="text-center text-slate-400 text-sm">Sin datos</p>}
                    </div>
                  </Card>
                </div>
              )}

              {activeTab === 'goals' && (
                <div className="space-y-4">
                  <div className="flex justify-between items-center px-1">
                     <h3 className="font-bold text-slate-700 dark:text-slate-200">Metas</h3>
                     <button onClick={() => setShowGoalModal(true)} className={`text-xs font-bold px-4 py-2 rounded-lg ${theme.bg} text-white shadow-sm`}>+ Nueva</button>
                  </div>
                  <div className="grid gap-4">
                      {currentGoals.map(g => {
                      const percent = Math.min(100, Math.round((g.current / g.target) * 100));
                      return (
                          <Card key={g.id} className="relative overflow-hidden border-l-4 border-slate-200 dark:border-zinc-800" style={{borderLeftColor: g.color}}>
                              <div className="flex justify-between items-end mb-3 relative z-10">
                                  <div>
                                      <h4 className="font-bold text-lg text-slate-800 dark:text-white">{g.name}</h4>
                                      <p className="text-xs text-slate-500 dark:text-slate-400">Meta: {formatCordoba(g.target)}</p>
                                  </div>
                                  <div className="text-right">
                                      <span className="text-xl font-bold text-slate-800 dark:text-white">{formatCordoba(g.current)}</span>
                                      <span className="block text-[10px] font-bold text-slate-400 uppercase">{percent}% logrado</span>
                                  </div>
                              </div>
                              <div className="w-full bg-slate-100 dark:bg-zinc-800 h-3 rounded-full overflow-hidden mb-4 relative">
                                  <div className="h-full transition-all duration-700 rounded-full" style={{width: `${percent}%`, backgroundColor: g.color}} />
                              </div>
                              <div className="flex justify-end gap-3 relative z-10 pt-3 border-t border-slate-50 dark:border-zinc-800">
                                  <button onClick={() => {
                                      const input = prompt(`Abonar a ${g.name} (C$):`);
                                      const add = Number(input);
                                      if(add && add > 0) {
                                         if(add > balance) {
                                            alert(`Sin fondos suficientes (${formatCordoba(balance)})`);
                                         } else {
                                            setGoals(goals.map(x => x.id === g.id ? {...x, current: x.current + add} : x));
                                         }
                                      }
                                  }} className={`text-xs font-bold ${theme.text} bg-slate-50 dark:bg-zinc-800 px-4 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-zinc-700`}>Abonar</button>
                                  <button onClick={() => setGoals(goals.filter(x => x.id !== g.id))} className="p-2 text-slate-400 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-lg"><Trash2 size={16} /></button>
                              </div>
                          </Card>
                      );
                      })}
                  </div>
                  {currentGoals.length === 0 && <div className="text-center py-16 text-slate-400 dark:text-slate-600 italic text-sm">Sin metas</div>}
                </div>
              )}

              {activeTab === 'profile' && (
                <div className="space-y-5">
                   <Card className="flex items-center gap-4 bg-slate-800 dark:bg-zinc-900 text-white border-none shadow-md">
                      <div className="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center text-3xl font-bold border-2 border-white/10">{currentProfile.gender === 'female' ? <UserCircle2 size={40} /> : <User size={40} />}</div>
                      <div className="flex-1">
                        <div className="flex items-center gap-2">
                           <h2 className="font-bold text-xl">{currentProfile.name}</h2>
                           <button onClick={() => { setTempName(currentProfile.name); setShowNameEdit(true); }} className="p-1 bg-white/10 rounded-full hover:bg-white/20 transition-colors"><Settings size={12}/></button>
                        </div>
                        <p className="text-slate-400 text-xs uppercase tracking-wide">ID: {walletMode === 'personal' ? 'Propietario' : 'Pareja'}</p>
                      </div>
                   </Card>

                   <div className="bg-white dark:bg-zinc-900 rounded-2xl p-5 shadow-sm border border-slate-100 dark:border-zinc-800">
                      <h4 className="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2"><Palette size={14}/> Tema</h4>
                      <div className="flex justify-between gap-2 overflow-x-auto pb-2 scrollbar-hide">
                         {Object.entries(THEME_COLORS).map(([key, val]) => (
                            <button key={key} onClick={() => updateProfile({ theme: key })} className={`w-10 h-10 rounded-full flex items-center justify-center transition-all shrink-0 ${val.bg} ${currentProfile.theme === key ? `ring-4 ring-offset-2 ${val.ring} ring-offset-white dark:ring-offset-zinc-900 scale-110` : 'opacity-50 hover:opacity-100'}`}>{currentProfile.theme === key && <Check size={16} className="text-white"/>}</button>
                         ))}
                      </div>
                   </div>

                   <div className="bg-white dark:bg-zinc-900 rounded-2xl overflow-hidden shadow-sm border border-slate-100 dark:border-zinc-800 divide-y divide-slate-100 dark:divide-zinc-800">
                      <div className="p-4 flex items-center justify-between">
                         <span className="font-medium text-slate-700 dark:text-white text-sm flex items-center gap-3"><User size={18} className="text-slate-400"/> Género</span>
                         <div className="flex bg-slate-100 dark:bg-zinc-800 p-1 rounded-lg">
                            <button onClick={() => updateProfile({ gender: 'male' })} className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${currentProfile.gender === 'male' ? 'bg-white dark:bg-zinc-700 shadow text-blue-500' : 'text-slate-400'}`}>Hombre</button>
                            <button onClick={() => updateProfile({ gender: 'female' })} className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${currentProfile.gender === 'female' ? 'bg-white dark:bg-zinc-700 shadow text-pink-500' : 'text-slate-400'}`}>Mujer</button>
                         </div>
                      </div>
                      <button onClick={() => setDarkMode(!darkMode)} className="w-full p-4 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-zinc-800 transition-colors">
                         <span className="font-medium text-slate-700 dark:text-white text-sm flex items-center gap-3"><Moon size={18} className="text-slate-400"/> Modo Oscuro</span>
                         <div className={`w-10 h-6 rounded-full relative transition-colors ${darkMode ? theme.bg : 'bg-slate-200'}`}><div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${darkMode ? 'left-5' : 'left-1'}`} /></div>
                      </button>
                      <button onClick={() => setShowResetConfirm(true)} className="w-full p-4 flex items-center justify-between hover:bg-rose-50 dark:hover:bg-rose-900/10 text-rose-500 transition-colors">
                         <span className="font-medium text-sm flex items-center gap-3"><Trash2 size={18} className="text-rose-400"/> Borrar datos de {currentProfile.name}</span>
                      </button>
                      <button onClick={() => setIsAuth(false)} className="w-full p-4 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-zinc-800 text-slate-500 transition-colors">
                         <span className="font-medium text-sm flex items-center gap-3"><LogOut size={18} className="text-slate-400"/> Cerrar Sesión</span>
                      </button>
                   </div>
                </div>
              )}
            </main>

            <nav className="fixed bottom-0 w-full bg-white dark:bg-zinc-900 border-t border-slate-100 dark:border-zinc-800 pb-safe z-30 transition-colors duration-300">
              <div className="flex justify-around items-center p-2">
                {['home', 'stats', 'plus', 'goals', 'profile'].map(item => {
                  if(item === 'plus') return (
                     <div key={item} className="relative -top-6">
                       <button onClick={() => { setTransForm({...transForm, type: 'expense'}); setShowTransModal(true); setFormError(''); }} className={`${theme.bg} text-white p-4 rounded-full shadow-lg active:scale-95 transition-transform border-4 border-slate-50 dark:border-zinc-950`}><Plus size={28} /></button>
                     </div>
                  );
                  const Icon = item === 'home' ? LayoutGrid : item === 'stats' ? PieIcon : item === 'goals' ? Target : Settings;
                  const label = item === 'home' ? 'Inicio' : item === 'stats' ? 'Análisis' : item === 'goals' ? 'Metas' : 'Perfil';
                  return (
                    <button key={item} onClick={() => setActiveTab(item)} className={`flex flex-col items-center p-2 rounded-xl transition-colors ${activeTab === item ? `${theme.text} dark:text-white` : 'text-slate-400 dark:text-slate-600'}`}><Icon size={24} strokeWidth={activeTab === item ? 2.5 : 2} /><span className="text-[10px] font-bold mt-1">{label}</span></button>
                  );
                })}
              </div>
            </nav>

            {/* MODAL TRANSACCION */}
            {showTransModal && (
              <div className="fixed inset-0 z-50 bg-black/80 flex items-end sm:items-center justify-center">
                <div className="bg-white dark:bg-zinc-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl border border-transparent dark:border-zinc-800">
                   <div className="flex justify-between items-center mb-6">
                     <h3 className="font-bold text-lg text-slate-800 dark:text-white">Nuevo Movimiento</h3>
                     <button onClick={() => setShowTransModal(false)} className="p-2 bg-slate-100 dark:bg-zinc-800 rounded-full hover:bg-slate-200 dark:hover:bg-zinc-700"><X size={20} className="text-slate-600 dark:text-white"/></button>
                   </div>
                   
                   {formError && (
                     <div className="mb-4 p-3 bg-rose-100 dark:bg-rose-900/30 border border-rose-200 dark:border-rose-800 rounded-xl flex items-center gap-3">
                       <Ban className="text-rose-500 shrink-0" size={20}/>
                       <span className="text-xs font-bold text-rose-600 dark:text-rose-400">{formError}</span>
                     </div>
                   )}

                   <div className="space-y-5">
                     <div className="flex bg-slate-100 dark:bg-zinc-800 p-1 rounded-xl">
                       <button onClick={() => { setTransForm({...transForm, type: 'income'}); setFormError(''); }} className={`flex-1 py-2 rounded-lg font-bold text-sm transition-colors ${transForm.type === 'income' ? 'bg-white dark:bg-zinc-700 text-emerald-500 shadow-sm' : 'text-slate-400'}`}>Ingreso</button>
                       <button onClick={() => { setTransForm({...transForm, type: 'expense'}); setFormError(''); }} className={`flex-1 py-2 rounded-lg font-bold text-sm transition-colors ${transForm.type === 'expense' ? 'bg-white dark:bg-zinc-700 text-rose-500 shadow-sm' : 'text-slate-400'}`}>Gasto</button>
                     </div>
                     <div className="relative">
                       <span className={`absolute top-1/2 -translate-y-1/2 left-4 text-2xl font-bold ${formError ? 'text-rose-300' : 'text-slate-300 dark:text-slate-600'}`}>C$</span>
                       <input 
                          type="number" 
                          inputMode="numeric" 
                          placeholder="0" 
                          className={`w-full pl-12 pr-4 py-4 text-4xl font-bold text-center bg-slate-50 dark:bg-zinc-800 rounded-2xl outline-none transition-colors ${formError ? 'text-rose-500 ring-2 ring-rose-500 bg-rose-50 dark:bg-rose-900/10' : 'text-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-200 dark:focus:ring-zinc-700'}`} 
                          value={transForm.amount} 
                          onChange={e => { setTransForm({...transForm, amount: e.target.value}); setFormError(''); }} 
                        />
                     </div>
                     <div className="flex items-center gap-3 bg-slate-50 dark:bg-zinc-800 p-3 rounded-2xl border border-slate-200 dark:border-zinc-800">
                       <Clock size={20} className="text-slate-400"/>
                       <input type="datetime-local" className="bg-transparent outline-none w-full font-bold text-slate-700 dark:text-white text-sm" value={transForm.date} onChange={e => setTransForm({...transForm, date: e.target.value})} />
                     </div>
                     <button onClick={() => setShowCatModal(true)} className="w-full p-4 bg-white dark:bg-zinc-800 border border-slate-200 dark:border-zinc-800 rounded-2xl flex justify-between items-center hover:border-indigo-300 transition-colors">
                        {transForm.categoryId ? (
                          <div className="flex items-center gap-3">
                            {(() => {
                              const c = categories.find(x => x.id === transForm.categoryId);
                              return c ? <><div style={{color: c.color}}><IconRenderer name={c.icon} size={24}/></div><span className="font-bold text-slate-700 dark:text-white">{c.name}</span></> : 'Error';
                            })()}
                          </div>
                        ) : <span className="text-slate-400 font-medium">Seleccionar Categoría</span>}
                        <ChevronRight size={20} className="text-slate-400"/>
                     </button>
                     <input placeholder="Nota (Opcional)" className="w-full p-4 bg-white dark:bg-zinc-800 border border-slate-200 dark:border-zinc-800 rounded-2xl outline-none text-slate-800 dark:text-white placeholder-slate-400 focus:border-indigo-400 transition-colors" value={transForm.desc} onChange={e => setTransForm({...transForm, desc: e.target.value})} />
                     <button onClick={handleAddTrans} className={`w-full py-4 rounded-xl text-white font-bold text-lg shadow-md active:scale-95 transition-transform ${transForm.type === 'income' ? 'bg-emerald-500' : 'bg-rose-500'}`}>Guardar</button>
                   </div>
                </div>
              </div>
            )}

            {/* MODAL CATEGORIAS */}
            {showCatModal && (
              <div className="fixed inset-0 z-50 bg-black/80 flex items-end sm:items-center justify-center">
                <div className="bg-white dark:bg-zinc-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 max-h-[80vh] overflow-y-auto shadow-2xl border border-transparent dark:border-zinc-800">
                   <div className="flex justify-between items-center mb-6">
                     <h3 className="font-bold text-lg text-slate-800 dark:text-white">Elige Categoría</h3>
                     <button onClick={() => setShowCatModal(false)} className="p-2 bg-slate-100 dark:bg-zinc-800 rounded-full hover:bg-slate-200 dark:hover:bg-zinc-700"><X size={20} className="text-slate-600 dark:text-white"/></button>
                   </div>
                   <div className="grid grid-cols-3 gap-3">
                     {categories.map(c => (
                       <button key={c.id} onClick={() => { setTransForm({...transForm, categoryId: c.id}); setShowCatModal(false); }} className="flex flex-col items-center gap-2 p-3 rounded-2xl border border-slate-100 dark:border-zinc-800 hover:bg-indigo-50 dark:hover:bg-zinc-800 transition-colors">
                         <div style={{color: c.color}} className="bg-slate-50 dark:bg-zinc-800 p-3 rounded-full"><IconRenderer name={c.icon} size={24}/></div>
                         <span className="text-xs font-bold text-slate-600 dark:text-slate-300">{c.name}</span>
                       </button>
                     ))}
                     <button onClick={() => { setShowCatModal(false); setShowCreateCat(true); }} className="flex flex-col items-center gap-2 p-3 rounded-2xl border border-dashed border-slate-300 dark:border-zinc-700 hover:bg-slate-50 dark:hover:bg-zinc-800">
                       <div className="bg-slate-100 dark:bg-zinc-800 p-3 rounded-full text-slate-400"><Plus size={24}/></div>
                       <span className="text-xs font-bold text-slate-400">Nueva</span>
                     </button>
                   </div>
                </div>
              </div>
            )}

            {showCreateCat && (
              <div className="fixed inset-0 z-50 bg-black/80 flex items-end sm:items-center justify-center">
                <div className="bg-white dark:bg-zinc-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl border border-transparent dark:border-zinc-800">
                   <h3 className="font-bold text-lg mb-4 text-slate-800 dark:text-white">Crear Categoría</h3>
                   <div className="space-y-4">
                     <input placeholder="Nombre" autoFocus className="w-full p-4 bg-slate-50 dark:bg-zinc-800 rounded-xl border-none outline-none font-bold text-slate-800 dark:text-white placeholder-slate-400" value={catForm.name} onChange={e => setCatForm({...catForm, name: e.target.value})} />
                     <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                       {Object.keys(ICON_MAP).map(k => (
                         <button key={k} onClick={() => setCatForm({...catForm, icon: k})} className={`p-3 rounded-xl shrink-0 transition-colors ${catForm.icon === k ? 'bg-indigo-600 text-white' : 'bg-slate-100 dark:bg-zinc-800 text-slate-400'}`}><IconRenderer name={k}/></button>
                       ))}
                     </div>
                     <div className="flex gap-3 overflow-x-auto pb-2 scrollbar-hide">
                       {['#ef4444', '#f97316', '#f59e0b', '#10b981', '#3b82f6', '#6366f1', '#ec4899'].map(c => (
                         <button key={c} onClick={() => setCatForm({...catForm, color: c})} style={{backgroundColor: c}} className={`w-10 h-10 rounded-full shrink-0 transition-transform ${catForm.color === c ? 'scale-110 ring-2 ring-slate-400' : ''}`}/>
                       ))}
                     </div>
                     <div className="flex gap-2 pt-2">
                       <button onClick={() => setShowCreateCat(false)} className="flex-1 py-3 rounded-xl font-bold text-slate-500 bg-slate-100 dark:bg-zinc-800">Cancelar</button>
                       <button onClick={() => { if(catForm.name) { setCategories([...categories, { id: `c-${Date.now()}`, ...catForm }]); setShowCreateCat(false); setShowCatModal(true); }}} className="flex-1 py-3 rounded-xl font-bold text-white bg-indigo-500 shadow-md">Crear</button>
                     </div>
                   </div>
                </div>
              </div>
            )}

            {showGoalModal && (
              <div className="fixed inset-0 z-50 bg-black/80 flex items-end sm:items-center justify-center">
                 <div className="bg-white dark:bg-zinc-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl border border-transparent dark:border-zinc-800">
                   <h3 className="font-bold text-lg mb-4 text-slate-800 dark:text-white">Nueva Meta</h3>
                   <div className="space-y-4">
                     <input placeholder="Nombre (ej. Moto)" className="w-full p-4 bg-slate-50 dark:bg-zinc-800 rounded-xl border-none outline-none font-bold text-slate-800 dark:text-white placeholder-slate-400" value={goalForm.name} onChange={e => setGoalForm({...goalForm, name: e.target.value})} />
                     <div className="relative">
                        <span className="absolute top-1/2 -translate-y-1/2 left-4 font-bold text-slate-400">C$</span>
                        <input type="number" placeholder="Objetivo" className="w-full pl-10 p-4 bg-slate-50 dark:bg-zinc-800 rounded-xl border-none outline-none font-bold text-slate-800 dark:text-white placeholder-slate-400" value={goalForm.target} onChange={e => setGoalForm({...goalForm, target: e.target.value})} />
                     </div>
                     <div className="flex gap-2 pt-2">
                       <button onClick={() => setShowGoalModal(false)} className="flex-1 py-3 rounded-xl font-bold text-slate-500 bg-slate-100 dark:bg-zinc-800">Cancelar</button>
                       <button onClick={handleAddGoal} className={`flex-1 py-3 rounded-xl font-bold text-white shadow-md ${theme.bg}`}>Guardar</button>
                     </div>
                   </div>
                 </div>
              </div>
            )}

            {showNameEdit && (
              <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
                 <div className="bg-white dark:bg-zinc-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl border border-transparent dark:border-zinc-800">
                   <h3 className="font-bold text-center mb-4 text-slate-800 dark:text-white">Cambiar Nombre</h3>
                   <input className="w-full p-3 bg-slate-100 dark:bg-zinc-800 rounded-xl text-center font-bold mb-4 text-slate-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-400 placeholder-slate-400" value={tempName} onChange={e => setTempName(e.target.value)} placeholder="Tu nombre" />
                   <div className="flex gap-2">
                     <button onClick={() => setShowNameEdit(false)} className="flex-1 py-2 rounded-xl font-bold text-slate-500 bg-slate-100 dark:bg-zinc-800">Cancelar</button>
                     <button onClick={handleUpdateName} className="flex-1 py-2 rounded-xl font-bold text-white bg-blue-500">Guardar</button>
                   </div>
                 </div>
              </div>
            )}

            {showResetConfirm && (
              <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
                 <div className="bg-white dark:bg-zinc-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl border border-rose-100 dark:border-rose-900/30">
                   <div className="flex justify-center mb-4 text-rose-500"><AlertTriangle size={40}/></div>
                   <h3 className="font-bold text-center mb-2 text-slate-800 dark:text-white">¿Borrar {currentProfile.name}?</h3>
                   <p className="text-center text-xs text-slate-400 mb-4">Solo se borrarán transacciones y metas de este perfil.</p>
                   <div className="flex gap-2">
                     <button onClick={() => setShowResetConfirm(false)} className="flex-1 py-2 rounded-xl font-bold text-slate-500 bg-slate-100 dark:bg-zinc-800">No</button>
                     <button onClick={handleResetProfileData} className="flex-1 py-2 rounded-xl font-bold text-white bg-rose-500">Sí, Borrar</button>
                   </div>
                 </div>
              </div>
            )}

          </>
        )}

      </div>
    </div>
  );
}


